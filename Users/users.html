<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Users - BlackBox</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .header {
      margin-bottom: 40px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 800;
      color: #ffffff;
      letter-spacing: -1px;
    }

    .search-bar {
      position: relative;
      flex: 1;
      max-width: 400px;
      min-width: 250px;
    }

    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      pointer-events: none;
    }

    .search-icon svg {
      width: 20px;
      height: 20px;
    }

    .search-input {
      width: 100%;
      padding: 14px 18px 14px 50px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      color: #ffffff;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.05);
      border-color: #4a4a4a;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
    }

    .search-input::placeholder {
      color: #555;
    }

    .filter-tabs {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      color: #888;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-tab:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: #3a3a3a;
      color: #fff;
    }

    .filter-tab.active {
      background: linear-gradient(135deg, #ffffff, #e0e0e0);
      color: #000;
      border-color: transparent;
    }

    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .user-card {
      background: linear-gradient(135deg, #1a1a1a, #141414);
      border: 1px solid #2a2a2a;
      border-radius: 20px;
      padding: 28px;
      position: relative;
      transition: all 0.3s ease;
    }

    .user-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
      border-color: #3a3a3a;
    }

    .user-status {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
    }
    
    .user-status.online {
      width: 12px;
      height: 12px;
      background: #00ff7f;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0, 255, 127, 0.5);
    }
    
    .user-status.offline {
      width: auto;
      height: auto;
      background: rgba(102, 102, 102, 0.2);
      border-radius: 20px;
      padding: 6px 12px;
      border: 1px solid #444;
    }
    
    .status-text {
      font-size: 0.75em;
      font-weight: 600;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #3a3a3a;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .user-avatar:hover {
      border-color: #00ff7f;
      box-shadow: 0 0 20px rgba(0, 255, 127, 0.3);
      transform: scale(1.05);
    }

    .user-avatar svg {
      width: 40px;
      height: 40px;
      color: #888;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-size: 1.3em;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .user-role {
      font-size: 0.85em;
      color: #888;
      font-weight: 500;
    }

    .user-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
    }

    .user-stat {
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .user-stat-value {
      font-size: 1.2em;
      font-weight: 700;
      color: #ffffff;
    }

    .user-stat-label {
      font-size: 0.7em;
      color: #777;
      text-transform: uppercase;
      font-weight: 500;
    }

    .user-bio {
      color: #999;
      font-size: 0.9em;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .user-actions {
      display: flex;
      gap: 12px;
    }

    .follow-btn,
    .view-profile-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .follow-btn {
      background: linear-gradient(135deg, #ff0050, #ff4081);
      color: #fff;
    }

    .follow-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #ff1a5e, #ff5a91);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 0, 80, 0.3);
    }

    .follow-btn.following {
      background: rgba(0, 255, 127, 0.15);
      color: #00ff7f;
      border: 1px solid rgba(0, 255, 127, 0.3);
    }

    .follow-btn.following:hover:not(:disabled) {
      background: rgba(255, 0, 80, 0.15);
      color: #ff0050;
      border-color: rgba(255, 0, 80, 0.3);
    }

    .follow-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .view-profile-btn {
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      border: 1px solid #3a3a3a;
    }

    .view-profile-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #4a4a4a;
      transform: translateY(-2px);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: linear-gradient(135deg, #1a1a1a, #141414);
      border: 1px solid #2a2a2a;
      border-radius: 24px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: slideUp 0.3s ease;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #3a3a3a;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #ff4444;
      transform: rotate(90deg);
    }

    .modal-close svg {
      width: 20px;
      height: 20px;
      color: #fff;
    }

    .modal-header {
      padding: 40px 40px 30px;
      border-bottom: 1px solid #2a2a2a;
    }

    .modal-profile-section {
      display: flex;
      align-items: center;
      gap: 30px;
      flex-wrap: wrap;
    }

    .modal-profile-pic {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: 3px solid #3a3a3a;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      overflow: hidden;
    }

    .modal-profile-pic svg {
      width: 60px;
      height: 60px;
      color: #888;
    }

    .modal-profile-info {
      flex: 1;
      min-width: 250px;
    }

    .modal-info-item {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      border-left: 3px solid #4a4a4a;
      border-radius: 8px;
    }

    .modal-info-label {
      color: #888;
      font-weight: 600;
      min-width: 100px;
      text-transform: uppercase;
      font-size: 0.75em;
      letter-spacing: 1px;
    }

    .modal-info-value {
      color: #ffffff;
      font-weight: 500;
      font-size: 1em;
    }

    .modal-body {
      padding: 30px 40px;
    }

    .modal-section {
      margin-bottom: 30px;
    }

    .modal-section-title {
      font-size: 1.5em;
      font-weight: 700;
      margin-bottom: 20px;
      color: #ffffff;
      letter-spacing: -0.5px;
    }

    .modal-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .modal-stat-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 24px 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .modal-stat-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: #3a3a3a;
    }

    .modal-stat-icon {
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-stat-icon svg {
      width: 36px;
      height: 36px;
      color: #888;
    }

    .modal-stat-value {
      font-size: 1.8em;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 6px;
    }

    .modal-stat-label {
      font-size: 0.8em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 500;
    }

    .modal-tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }

    .modal-tool-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .modal-tool-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: #3a3a3a;
      transform: translateY(-2px);
    }

    .modal-tool-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .modal-tool-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 1px solid #3a3a3a;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .modal-tool-icon svg {
      width: 24px;
      height: 24px;
      color: #888;
    }

    .modal-tool-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .modal-tool-name {
      font-size: 1.1em;
      font-weight: 700;
      color: #ffffff;
    }

    .modal-tool-desc {
      color: #999;
      font-size: 0.85em;
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .modal-tool-downloads {
      color: #00ff7f;
      font-size: 0.85em;
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      grid-column: 1/-1;
    }

    .empty-state svg {
      width: 60px;
      height: 60px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state-text {
      font-size: 1.1em;
      margin-bottom: 6px;
    }

    .empty-state-subtext {
      font-size: 0.85em;
      color: #555;
    }

    .skeleton-loader {
      display: block;
    }

    .skeleton-loader.hidden {
      display: none;
    }

    .skeleton {
      background: linear-gradient(
        90deg,
        rgba(255, 255, 255, 0.03) 0%,
        rgba(255, 255, 255, 0.08) 50%,
        rgba(255, 255, 255, 0.03) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }

    .skeleton-card {
      background: linear-gradient(135deg, #1a1a1a, #141414);
      border: 1px solid #2a2a2a;
      border-radius: 20px;
      padding: 28px;
      position: relative;
    }

    .skeleton-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #2a2a2a;
    }

    .skeleton-text {
      height: 16px;
      margin-bottom: 12px;
      border-radius: 4px;
    }

    .skeleton-text.large {
      height: 24px;
      width: 60%;
    }

    .skeleton-text.medium {
      height: 18px;
      width: 40%;
    }

    .skeleton-text.small {
      height: 14px;
      width: 80%;
    }

    .skeleton-button {
      height: 44px;
      border-radius: 10px;
    }

    @keyframes fadeInCard {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-card.fade-in {
      animation: fadeInCard 0.5s ease-out;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #1a1a1a, #141414);
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 16px 24px;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      z-index: 10000;
      animation: slideInRight 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toast.success {
      border-left: 3px solid #00ff7f;
    }

    .toast.error {
      border-left: 3px solid #ff0050;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .load-more {
      text-align: center;
      padding: 30px;
      grid-column: 1/-1;
    }

    .load-more-btn {
      padding: 14px 32px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #3a3a3a;
      border-radius: 12px;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .load-more-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #4a4a4a;
      transform: translateY(-2px);
    }

    .load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }

      .header h1 {
        font-size: 2em;
      }

      .users-grid {
        grid-template-columns: 1fr;
      }

      .header-top {
        flex-direction: column;
        align-items: stretch;
      }

      .search-bar {
        max-width: 100%;
      }

      .modal-content {
        border-radius: 16px;
        max-height: 95vh;
      }

      .modal-header,
      .modal-body {
        padding: 24px 20px;
      }

      .modal-profile-section {
        flex-direction: column;
        text-align: center;
      }

      .modal-profile-pic {
        width: 120px;
        height: 120px;
      }

      .modal-stats-grid {
        grid-template-columns: 1fr;
      }

      .modal-tools-grid {
        grid-template-columns: 1fr;
      }

      .toast {
        bottom: 20px;
        right: 20px;
        left: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="modal-overlay" id="userModal">
    <div class="modal-content">
      <div class="modal-close" id="closeModal">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </div>

      <div class="modal-header">
        <div class="modal-profile-section">
          <div class="modal-profile-pic" id="modalProfilePic">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </div>
          <div class="modal-profile-info">
            <div class="modal-info-item">
              <span class="modal-info-label">Username:</span>
              <span class="modal-info-value" id="modalUserName">Loading...</span>
            </div>
            <div class="modal-info-item">
              <span class="modal-info-label">Gender:</span>
              <span class="modal-info-value" id="modalGender">Loading...</span>
            </div>
            <div class="modal-info-item">
              <span class="modal-info-label">Role:</span>
              <span class="modal-info-value" id="modalRole">Loading...</span>
            </div>
            <div class="modal-info-item">
              <span class="modal-info-label">Status:</span>
              <span class="modal-info-value" id="modalStatus">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-body">
        <div class="modal-section">
          <h2 class="modal-section-title">Statistics</h2>
          <div class="modal-stats-grid">
            <div class="modal-stat-card">
              <div class="modal-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
              </div>
              <div class="modal-stat-value" id="modalFollowers">0</div>
              <div class="modal-stat-label">Followers</div>
            </div>
            <div class="modal-stat-card">
              <div class="modal-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              </div>
              <div class="modal-stat-value" id="modalDownloads">0</div>
              <div class="modal-stat-label">Downloads</div>
            </div>
            <div class="modal-stat-card">
              <div class="modal-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M2 12h20"/></svg>
              </div>
              <div class="modal-stat-value" id="modalToolsDeployed"></div>
              <div class="modal-stat-label">Tools Deployed</div>
            </div>
          </div>
        </div>

        <div class="modal-section">
          <h2 class="modal-section-title">Deployed Tools</h2>
          <div class="modal-tools-grid" id="modalToolsGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="header-top">
        <h1>Find Users</h1>
        <div class="search-bar">
          <div class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          </div>
          <input type="text" class="search-input" id="searchInput" placeholder="Search users...">
        </div>
      </div>
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">All Users</button>
        <button class="filter-tab" data-filter="online">Online</button>
        <button class="filter-tab" data-filter="offline">Offline</button>
      </div>
    </div>

    <div id="skeletonLoader" class="skeleton-loader">
      <div class="users-grid" id="skeletonGrid"></div>
    </div>

    <div class="users-grid" id="usersGrid" style="display: none;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { ref, get, set, remove, getDatabase, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsOwXNtfaWwEh3qaM0suXafOg6CYLzDC8",
      authDomain: "uamtv-c031c.firebaseapp.com",
      databaseURL: "https://uamtv-c031c-default-rtdb.firebaseio.com",
      projectId: "uamtv-c031c",
      storageBucket: "uamtv-c031c.firebasestorage.app",
      messagingSenderId: "9790917697",
      appId: "1:9790917697:web:275c8347b7688e0ac38ac0",
      measurementId: "G-RSXW1XBVQZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase();

    let currentUser = null;
    let allUsers = {};
    let displayedUsers = [];
    let currentFilter = 'all';
    let searchQuery = '';
    let followingCache = {};

    const usersGrid = document.getElementById("usersGrid");
    const skeletonLoader = document.getElementById("skeletonLoader");
    const skeletonGrid = document.getElementById("skeletonGrid");
    const userModal = document.getElementById("userModal");
    const closeModal = document.getElementById("closeModal");
    const searchInput = document.getElementById("searchInput");
    const filterTabs = document.querySelectorAll(".filter-tab");
    const modalDownloads = document.getElementById("modalDownloads");

    // Toast notification system
    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          ${type === 'success' 
            ? '<polyline points="20 6 9 17 4 12"/>' 
            : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'
          }
        </svg>
        <span>${message}</span>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideInRight 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Auth state listener
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        loadFollowingData(user.uid);
      }
    });

    // Load user's following data
    async function loadFollowingData(userId) {
      try {
        const followingRef = ref(db, `following/${userId}`);
        const snapshot = await get(followingRef);
        followingCache = snapshot.exists() ? snapshot.val() : {};
        updateFollowButtons();
      } catch (error) {
        console.error("Error loading following data:", error);
      }
    }

    // Check if current user is following a specific user
    function isFollowing(userId) {
      return followingCache[userId] === true;
    }

    // Follow/Unfollow functionality
    async function toggleFollow(userId, button) {
      if (!currentUser) {
        showToast('Please log in to follow users', 'error');
        return;
      }

      if (currentUser.uid === userId) {
        showToast('You cannot follow yourself', 'error');
        return;
      }

      button.disabled = true;
      const wasFollowing = isFollowing(userId);

      try {
        if (wasFollowing) {
          // Unfollow
          await remove(ref(db, `following/${currentUser.uid}/${userId}`));
          await remove(ref(db, `followers/${userId}/${currentUser.uid}`));
          
          delete followingCache[userId];
          button.classList.remove('following');
          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <line x1="20" y1="8" x2="20" y2="14"/>
              <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            Follow
          `;
          showToast('Unfollowed successfully', 'success');
        } else {
          // Follow
          await set(ref(db, `following/${currentUser.uid}/${userId}`), true);
          await set(ref(db, `followers/${userId}/${currentUser.uid}`), true);
          
          followingCache[userId] = true;
          button.classList.add('following');
          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Following
          `;
          showToast('Following successfully', 'success');
        }

        // Update follower count in the card
        const card = button.closest('.user-card');
        if (card) {
          const statsElement = card.querySelector('.user-stats');
          await loadUserStats(userId, statsElement);
        }

      } catch (error) {
        console.error("Error toggling follow:", error);
        showToast('Failed to update follow status', 'error');
      } finally {
        button.disabled = false;
      }
    }

    // Update all follow buttons based on current following state
    function updateFollowButtons() {
      document.querySelectorAll('.follow-btn').forEach(button => {
        const userId = button.getAttribute('data-user-id');
        if (isFollowing(userId)) {
          button.classList.add('following');
          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Following
          `;
        } else {
          button.classList.remove('following');
          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <line x1="20" y1="8" x2="20" y2="14"/>
              <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            Follow
          `;
        }
      });
    }

    // Close modal handlers
    closeModal.addEventListener('click', () => {
      userModal.classList.remove('active');
    });

    userModal.addEventListener('click', (e) => {
      if (e.target === userModal) {
        userModal.classList.remove('active');
      }
    });

    // Search functionality with debounce
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchQuery = e.target.value.toLowerCase();
        filterAndDisplayUsers();
      }, 300);
    });

    // Filter tabs
    filterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        filterTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.getAttribute('data-filter');
        filterAndDisplayUsers();
      });
    });

    // Filter and display users based on search and filter
    function filterAndDisplayUsers() {
      const filtered = Object.keys(allUsers).filter(userId => {
        const user = allUsers[userId];
        
        // Hide current user
        if (currentUser && userId === currentUser.uid) {
          return false;
        }

        // Search filter
        const matchesSearch = !searchQuery || 
          (user.nickname || '').toLowerCase().includes(searchQuery) ||
          (user.role || '').toLowerCase().includes(searchQuery) ||
          (user.bio || '').toLowerCase().includes(searchQuery);

        if (!matchesSearch) return false;

        // Status filter
        if (currentFilter === 'online') {
          return user.status === 'online';
        } else if (currentFilter === 'offline') {
          return user.status === 'offline' || !user.status;
        }

        return true;
      });

      displayedUsers = filtered;
      renderUsers(filtered);
    }

    // Render users to the grid
    function renderUsers(userIds) {
      usersGrid.innerHTML = '';

      if (userIds.length === 0) {
        usersGrid.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
            <div class="empty-state-text">No users found</div>
            <div class="empty-state-subtext">Try adjusting your search or filters</div>
          </div>
        `;
        return;
      }

      userIds.forEach((userId, index) => {
        const user = allUsers[userId];
        const card = createUserCard(userId, user, index);
        usersGrid.appendChild(card);
      });
    }

    // Create user card
    function createUserCard(userId, user, index) {
      const card = document.createElement("div");
      card.className = "user-card fade-in";
      card.style.animationDelay = `${index * 0.05}s`;

      // STATUS
      const status = document.createElement("div");
      status.className = "user-status";

      if (user.status === "offline" || !user.status) {
        status.classList.add("offline");
        const offlineText = document.createElement("span");
        offlineText.className = "status-text";
        offlineText.textContent = "offline";
        status.appendChild(offlineText);
      } else {
        status.classList.add("online");
      }

      card.appendChild(status);

      // HEADER
      const header = document.createElement("div");
      header.className = "user-header";

      const avatar = document.createElement("div");
      avatar.className = "user-avatar";
      
      if (user.avatar) {
        avatar.innerHTML = `<img src="${user.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
      } else {
        avatar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
      }
      
      avatar.addEventListener('click', () => {
        showUserProfile(userId, user);
      });

      const info = document.createElement("div");
      info.className = "user-info";

      const nameEl = document.createElement("div");
      nameEl.className = "user-name";
      nameEl.textContent = user.nickname || 'Anonymous';

      const roleEl = document.createElement("div");
      roleEl.className = "user-role";
      roleEl.textContent = user.role || 'User';

      info.appendChild(nameEl);
      info.appendChild(roleEl);
      header.appendChild(avatar);
      header.appendChild(info);
      card.appendChild(header);

      // STATS
      const stats = document.createElement("div");
      stats.className = "user-stats";

      function makeStat(value, label) {
        const stat = document.createElement("div");
        stat.className = "user-stat";

        const val = document.createElement("span");
        val.className = "user-stat-value";
        val.textContent = value;

        const lbl = document.createElement("span");
        lbl.className = "user-stat-label";
        lbl.textContent = label;

        stat.appendChild(val);
        stat.appendChild(lbl);
        return stat;
      }

      stats.appendChild(makeStat('...', "Tools"));
      stats.appendChild(makeStat('...', "Downloads"));
      stats.appendChild(makeStat('...', "Followers"));
      card.appendChild(stats);

      loadUserStats(userId, stats);

      // BIO
      const bio = document.createElement("div");
      bio.className = "user-bio";
      bio.textContent = user.bio || "No bio yet";
      card.appendChild(bio);

      // ACTION BUTTONS
      const actions = document.createElement("div");
      actions.className = "user-actions";

      const followBtn = document.createElement("button");
      followBtn.className = "follow-btn";
      followBtn.setAttribute('data-user-id', userId);
      
      if (currentUser && currentUser.uid === userId) {
        followBtn.style.display = 'none';
      } else if (isFollowing(userId)) {
        followBtn.classList.add('following');
        followBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Following
        `;
      } else {
        followBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <line x1="20" y1="8" x2="20" y2="14"/>
            <line x1="23" y1="11" x2="17" y2="11"/>
          </svg>
          Follow
        `;
      }

      followBtn.addEventListener('click', () => {
        toggleFollow(userId, followBtn);
      });

      const viewProfileBtn = document.createElement("button");
      viewProfileBtn.className = "view-profile-btn";
      viewProfileBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        View Profile
      `;
      viewProfileBtn.addEventListener('click', () => {
        showUserProfile(userId, user);
      });

      actions.appendChild(followBtn);
      actions.appendChild(viewProfileBtn);
      card.appendChild(actions);

      return card;
    }

    // Load user stats
    async function loadUserStats(userId, statsElement) {
      try {
        const toolsRef = ref(db, `tools/${userId}`);
        const toolsSnapshot = await get(toolsRef);
        
        let toolsCount = 0;
        let totalDownloads = 0;
        
        if (toolsSnapshot.exists()) {
          const tools = toolsSnapshot.val();
          toolsCount = Object.keys(tools).length;
          
          Object.values(tools).forEach(tool => {
            totalDownloads += tool.downloadCount || 0;
            modalDownloads.textContent = totalDownloads;
            
          });
        }
        
        const followersRef = ref(db, `followers/${userId}`);
        const followersSnapshot = await get(followersRef);
        const followersCount = followersSnapshot.exists() ? Object.keys(followersSnapshot.val()).length : 0;
        
        const statValues = statsElement.querySelectorAll('.user-stat-value');
        statValues[0].textContent = toolsCount;
        statValues[1].textContent = totalDownloads;
        statValues[2].textContent = followersCount;
        
      } catch (error) {
        console.error('Error loading user stats:', error);
      }
    }

    // Load user tools in modal
    async function loadModalUserTools(userId) {
      const toolsRef = ref(db, `tools/${userId}`);
      const modalToolsGrid = document.getElementById('modalToolsGrid');
      
      try {
        const snapshot = await get(toolsRef);
        
        modalToolsGrid.innerHTML = '';
        
        if (snapshot.exists()) {
          const tools = snapshot.val();
          const toolsArray = Object.keys(tools);
          
          let totalDownloads = 0;
          
          toolsArray.forEach(toolId => {
            const tool = tools[toolId];
            
            const toolIcon = tool.image 
              ? `<img src="${tool.image}" alt="${tool.name}">`
              : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M2 12h20"/></svg>';
            
            const toolCard = document.createElement('div');
            toolCard.className = 'modal-tool-card';
            
            toolCard.innerHTML = `
              <div class="modal-tool-header">
                <div class="modal-tool-icon">${toolIcon}</div>
                <div class="modal-tool-name">${tool.name || 'Unnamed Tool'}</div>
              </div>
              <p class="modal-tool-desc">${tool.description || 'No description available'}</p>
              <div class="modal-tool-downloads">ðŸ“¥ ${tool.downloadCount
                || 0} downloads</div>
            `;
            
            totalDownloads += tool.downloadCount || 0;
            modalToolsGrid.appendChild(toolCard);
          });
          
          document.getElementById('modalDownloads').textContent = totalDownloads;
          document.getElementById('modalToolsDeployed').textContent = toolsArray.length;
          
        } else {
          modalToolsGrid.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg>
              <div class="empty-state-text">No tools deployed yet</div>
              <div class="empty-state-subtext">This user hasn't deployed any tools</div>
            </div>
          `;
          
          document.getElementById('modalDownloads').textContent = 0;
          document.getElementById('modalToolsDeployed').textContent = 0;
        }
      } catch (error) {
        console.error("Error loading tools:", error);
        modalToolsGrid.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            <div class="empty-state-text">Error loading tools</div>
          </div>
        `;
      }
    }

    // Show user profile modal
    async function showUserProfile(userId, userData) {
      const modalProfilePic = document.getElementById('modalProfilePic');
      const modalUserName = document.getElementById('modalUserName');
      const modalGender = document.getElementById('modalGender');
      const modalRole = document.getElementById('modalRole');
      const modalStatus = document.getElementById('modalStatus');
      const modalFollowers = document.getElementById('modalFollowers');
      
      if (userData.avatar) {
        modalProfilePic.innerHTML = `<img src="${userData.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
      } else {
        modalProfilePic.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
      }
      
      modalUserName.textContent = userData.nickname || 'Anonymous';
      modalGender.textContent = userData.gender || 'Not specified';
      modalRole.textContent = userData.role || 'User';
      modalStatus.textContent = userData.status || 'offline';
      
      try {
        const followersRef = ref(db, `followers/${userId}`);
        const followersSnapshot = await get(followersRef);
        const followersCount = followersSnapshot.exists() ? Object.keys(followersSnapshot.val()).length : 0;
        modalFollowers.textContent = followersCount;
      } catch (error) {
        console.error('Error loading followers:', error);
        modalFollowers.textContent = 0;
      }
      
      await loadModalUserTools(userId);
      
      userModal.classList.add('active');
    }

    // Create skeleton card
    function createSkeletonCard() {
      const card = document.createElement("div");
      card.className = "skeleton-card";
      card.innerHTML = `
        <div class="user-header">
          <div class="skeleton skeleton-avatar"></div>
          <div style="flex: 1;">
            <div class="skeleton skeleton-text large" style="margin-bottom: 8px;"></div>
            <div class="skeleton skeleton-text medium"></div>
          </div>
        </div>
        <div class="user-stats">
          <div style="text-align: center; flex: 1;">
            <div class="skeleton skeleton-text" style="width: 40px; margin: 0 auto 8px;"></div>
            <div class="skeleton skeleton-text" style="width: 50px; height: 12px; margin: 0 auto;"></div>
          </div>
          <div style="text-align: center; flex: 1;">
            <div class="skeleton skeleton-text" style="width: 40px; margin: 0 auto 8px;"></div>
            <div class="skeleton skeleton-text" style="width: 50px; height: 12px; margin: 0 auto;"></div>
          </div>
          <div style="text-align: center; flex: 1;">
            <div class="skeleton skeleton-text" style="width: 40px; margin: 0 auto 8px;"></div>
            <div class="skeleton skeleton-text" style="width: 50px; height: 12px; margin: 0 auto;"></div>
          </div>
        </div>
        <div class="skeleton skeleton-text small" style="margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-text small" style="width: 90%; margin-bottom: 20px;"></div>
        <div style="display: flex; gap: 12px;">
          <div class="skeleton skeleton-button" style="flex: 1;"></div>
          <div class="skeleton skeleton-button" style="flex: 1;"></div>
        </div>
      `;
      return card;
    }

    // Generate skeleton cards
    const skeletonCount = 6;
    for (let i = 0; i < skeletonCount; i++) {
      skeletonGrid.appendChild(createSkeletonCard());
    }

    skeletonLoader.classList.remove("hidden");
    usersGrid.style.display = "none";

    // Load users from Firebase
    onValue(ref(db, "users"), (snapshot) => {
      setTimeout(() => {
        skeletonLoader.classList.add("hidden");
        usersGrid.style.display = "grid";

        if (snapshot.exists()) {
          allUsers = snapshot.val();
          filterAndDisplayUsers();
          console.log("âœ… Users loaded successfully");
        } else {
          usersGrid.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
              </svg>
              <div class="empty-state-text">No users yet</div>
              <div class="empty-state-subtext">Be the first to join!</div>
            </div>
          `;
        }
      }, 1000);
    });
  </script>
</body>
</html>