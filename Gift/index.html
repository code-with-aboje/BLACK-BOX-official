<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transaction History - BlackBox</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .header {
      text-align: center;
      padding: 30px 0;
      margin-bottom: 40px;
    }

    .header-title {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 800;
      color: #ffffff;
      letter-spacing: -1px;
      margin: 0;
    }

    .header p {
      color: #888;
      font-size: 1.05em;
    }

    .transactions-section {
      background: linear-gradient(135deg, #1a1a1a, #141414);
      border: 1px solid #2a2a2a;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .section-title {
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 30px;
      color: #ffffff;
      letter-spacing: -0.5px;
    }

    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      color: #888;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-btn:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: #3a3a3a;
    }

    .filter-btn.active {
      background: rgba(0, 255, 127, 0.1);
      border-color: #00ff7f;
      color: #00ff7f;
    }

    .gift-image{
        width: 55%;
        height: 200px;
        display: block;
        margin: 0 auto;
        display: flex;
        justify-content:center;
    }
    .gift-image img{
        width: inherit;
        height: inherit;
    }

    @media(max-width:600px){
        .gift-image{
            width: 80%;
            height: 200px;
        }
    }

    #search{
      width: 100%;
      padding: 16px 8px 16px 15px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      color: #ffffff;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0px 8px 24px rgba(0, 0, 0, 0.4);
      border: 1px solid rgb(49, 116, 49);
    }

    #searchBtn{
        box-shadow: 0px 8px 24px rgba(0, 0, 0, 0.4);
        color: white;
    }

    .userCard{
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        background: linear-gradient(135deg, #1a1a1a, #141414);
        border: 1px solid #2a2a2a;
        border-radius: 20px;
        padding: 24px;
        display: none;
        flex-direction: column;
        gap: 20px;
        margin-top: 30px;
        animation: slideIn 0.4s ease;
    }

    .userCard.show {
        display: flex;
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #2a2a2a;
    }

    .avater{
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        background: linear-gradient(135deg, #1a1a1a, #141414);
        border: 2px solid rgba(0, 255, 127, 0.3);
        height: 80px;
        width: 80px;
        border-radius: 50%;
        overflow: hidden;
    }

    .avater img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }

    .details{
        flex: 1;
    }

    .details h3 {
        color: #ffffff;
        font-size: 1.3em;
        margin-bottom: 6px;
    }

    .details p {
        color: #888;
        font-size: 0.95em;
    }

    .gift-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .gift-input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .gift-input-group label {
        color: #888;
        font-size: 0.9em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .gift-input-group input {
        width: 100%;
        padding: 14px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid #2a2a2a;
        border-radius: 10px;
        color: #ffffff;
        font-size: 1.1em;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .gift-input-group input:focus {
        outline: none;
        border-color: #00ff7f;
        background: rgba(0, 255, 127, 0.05);
    }

    .gift-btn {
        padding:10px 16px;
        background: linear-gradient(135deg, #1a1a1a, #141414);
        border:1px solid white;
        border-radius: 10px;
        color:white;
        font-weight: 700;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow:0px 8px 24px rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .gift-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 30px rgba(0, 255, 127, 0.5);
    }

    .gift-btn:disabled {
        background: #2a2a2a;
        color: #666;
        cursor: not-allowed;
        box-shadow: none;
    }

    .loading-spinner {
        display: none;
        justify-content: center;
        align-items: center;
        padding: 40px;
    }

    .loading-spinner.show {
        display: flex;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(0, 255, 127, 0.1);
        border-top: 4px solid #00ff7f;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }

      .header h1 {
        font-size: 2em;
      }

      .transactions-section {
        padding: 24px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <br>
    <div class="header">
      <div class="header-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 64 64"><title>Wrapped-gift SVG Icon</title><path fill="currentColor" d="M51.429 15.856c4.558-4.299-.715-9.875-10.687-6.421c-.587.204-1.133.419-1.648.642c.977-1.876 2.42-3.924 4.58-5.885c0 0-4.034 1.449-5.898 1.082C35.464 4.819 34.739 2 34.739 2s-2.405 5.238-3.63 9.349c-1.754-3.532-3.697-6.969-3.697-6.969s-1.037 2.404-2.936 3.318c-1.531.74-7.829 1.378-7.829 1.378c2.1 1.074 3.903 2.401 5.433 3.774c-1.609-.426-3.446-.746-5.547-.898c-8.344-.605-11.621 2.372-10.505 5.313L2 17.394l2.192 8.219L5.554 26c3.232 10.949 2.45 23.098 2.44 23.235l-.055.792l.754.222C20.766 53.805 31.735 62 31.735 62s14.222-9.412 22.042-11.753l.684-.205l.014-.72c.004-.17.346-15.334 4.271-25.218c.276-.039.536-.07.759-.084l.827-.05l.083-.832c.003-.033.341-4.796 1.586-6.739zM4.587 19.7l6.483 1.759v4.063l-5.381-1.528zm10.074 30.512a70.37 70.37 0 0 0-4.681-1.63c.128-2.822.313-12.549-2.233-21.96l4.71 1.338c.912 4.023 2.426 12.311 2.204 22.252m7.893-35.169c8.094.586 9.517 4.764 9.517 4.764s-4.931 1.803-7.978 1.803c-9.942 0-11.378-7.28-1.539-6.567m9.988 5.379l8.126.921l-10.13 2.451l-5.786-1.293zm-9.729 3.661l6.76 1.51v5.184l-6.979-1.947zm8.041 34.937c-1.476-1.096-3.936-2.787-7.202-4.6c.259-4.777.29-17.541.291-23.198l6.911 1.963zm9.046-4.356a138.415 138.415 0 0 0-7.1 4.496V32.29a510.721 510.721 0 0 1 8.162-2.917c-.587 5.658-.954 20.424-1.062 25.291m3.28-27.832s-9.738 3.125-11.659 3.834V25.58l11.811-2.858zm-1.2-7.461c-4.559 1.168-9.408.344-9.408.344s-.909-4.465 6.451-7.014c8.946-3.099 12.483 4.229 2.957 6.67m6.711-1.699l5.796.326l-3.481.843l-4.157-.41c.673-.234 1.284-.49 1.842-.759m3.856 30.9c-1.447.473-2.973 1.092-4.511 1.793c.011-4.684.297-15.066 2.467-24.145c2.231-.688 4.299-1.275 5.987-1.672c-3.227 8.986-3.838 20.96-3.943 24.024m6.038-26.431s-3.201.938-5.245 1.502l.514-3.468l5.565-1.346c-.456 1.255-.834 3.312-.834 3.312" style="color: #00ff9c;"/></svg>
        <h1>Gift Friends</h1>
      </div>
      <p>Share tokens across close friends</p>
      <br>
      <div class="gift-image">
        <img src="../Assets/gift.png" alt="Gift">
      </div>
    </div>

    <div class="transactions-section">
      <h2 class="section-title">Search for friends to gift</h2>
      
      <div class="filter-bar">
        <input
         type="text"
         id="search"
         placeholder="User id..."
         >
        <button class="filter-btn" data-filter="month" id="searchBtn">Search</button>
      </div>

      <!-- Loading Spinner -->
      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
      </div>

      <!-- User details -->
      <div class="userCard" id="userCard">
        <div class="user-profile">
          <div class="avater" id="avatar"></div>
          <div class="details">
            <h3 id="userName"></h3>
            <p id="userRole"></p>
          </div>
        </div>
        
        <div class="gift-form">
          <div class="gift-input-group">
            <label for="tokenAmount">Gift Amount</label>
            <input 
              type="number" 
              id="tokenAmount" 
              placeholder="Enter number of tokens..." 
              min="1"
            >
          </div>
          <button class="gift-btn" id="giftBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 64 64"><title>Wrapped-gift SVG Icon</title><path fill="#ffffff" d="M51.429 15.856c4.558-4.299-.715-9.875-10.687-6.421c-.587.204-1.133.419-1.648.642c.977-1.876 2.42-3.924 4.58-5.885c0 0-4.034 1.449-5.898 1.082C35.464 4.819 34.739 2 34.739 2s-2.405 5.238-3.63 9.349c-1.754-3.532-3.697-6.969-3.697-6.969s-1.037 2.404-2.936 3.318c-1.531.74-7.829 1.378-7.829 1.378c2.1 1.074 3.903 2.401 5.433 3.774c-1.609-.426-3.446-.746-5.547-.898c-8.344-.605-11.621 2.372-10.505 5.313L2 17.394l2.192 8.219L5.554 26c3.232 10.949 2.45 23.098 2.44 23.235l-.055.792l.754.222C20.766 53.805 31.735 62 31.735 62s14.222-9.412 22.042-11.753l.684-.205l.014-.72c.004-.17.346-15.334 4.271-25.218c.276-.039.536-.07.759-.084l.827-.05l.083-.832c.003-.033.341-4.796 1.586-6.739zM4.587 19.7l6.483 1.759v4.063l-5.381-1.528zm10.074 30.512a70.37 70.37 0 0 0-4.681-1.63c.128-2.822.313-12.549-2.233-21.96l4.71 1.338c.912 4.023 2.426 12.311 2.204 22.252m7.893-35.169c8.094.586 9.517 4.764 9.517 4.764s-4.931 1.803-7.978 1.803c-9.942 0-11.378-7.28-1.539-6.567m9.988 5.379l8.126.921l-10.13 2.451l-5.786-1.293zm-9.729 3.661l6.76 1.51v5.184l-6.979-1.947zm8.041 34.937c-1.476-1.096-3.936-2.787-7.202-4.6c.259-4.777.29-17.541.291-23.198l6.911 1.963zm9.046-4.356a138.415 138.415 0 0 0-7.1 4.496V32.29a510.721 510.721 0 0 1 8.162-2.917c-.587 5.658-.954 20.424-1.062 25.291m3.28-27.832s-9.738 3.125-11.659 3.834V25.58l11.811-2.858zm-1.2-7.461c-4.559 1.168-9.408.344-9.408.344s-.909-4.465 6.451-7.014c8.946-3.099 12.483 4.229 2.957 6.67m6.711-1.699l5.796.326l-3.481.843l-4.157-.41c.673-.234 1.284-.49 1.842-.759m3.856 30.9c-1.447.473-2.973 1.092-4.511 1.793c.011-4.684.297-15.066 2.467-24.145c2.231-.688 4.299-1.275 5.987-1.672c-3.227 8.986-3.838 20.96-3.943 24.024m6.038-26.431s-3.201.938-5.245 1.502l.514-3.468l5.565-1.346c-.456 1.255-.834 3.312-.834 3.312" style="color: white;"/></svg>&nbsp Send Gift
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { ref, update, getDatabase, get, child } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsOwXNtfaWwEh3qaM0suXafOg6CYLzDC8",
      authDomain: "uamtv-c031c.firebaseapp.com",
      databaseURL: "https://uamtv-c031c-default-rtdb.firebaseio.com",
      projectId: "uamtv-c031c",
      storageBucket: "uamtv-c031c.firebasestorage.app",
      messagingSenderId: "9790917697",
      appId: "1:9790917697:web:275c8347b7688e0ac38ac0",
      measurementId: "G-RSXW1XBVQZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase();
    const auth = getAuth(app);

    const userName = document.getElementById("userName");
    const userRole = document.getElementById("userRole");
    const searchBtn = document.getElementById("searchBtn");
    const search = document.getElementById("search");
    const avatar = document.getElementById("avatar");
    const userCard = document.getElementById("userCard");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const tokenAmount = document.getElementById("tokenAmount");
    const giftBtn = document.getElementById("giftBtn");

    let currentUserId = null;
    let currentUserData = null;
    let searchedUserId = null;

    // Get current logged-in user
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        // Fetch current user's data
        get(child(ref(db), `users/${currentUserId}`)).then((snapshot) => {
          if (snapshot.exists()) {
            currentUserData = snapshot.val();
          }
        });
      }
    });

    const userRef = ref(db, "users/");

    searchBtn.addEventListener('click', async () => {
      const searchValue = search.value.trim();
      search.value = '';
      
      if (!searchValue) {
        alert('Please enter a user ID');
        return;
      }

      // Show loading, hide card
      loadingSpinner.classList.add('show');
      userCard.classList.remove('show');

      try {
        const snapshot = await get(userRef);
        
        if (snapshot.exists()) {
          const data = snapshot.val();
          const userIds = Object.keys(data);

          // Simulate loading delay for better UX
          setTimeout(() => {
            loadingSpinner.classList.remove('show');

            if (userIds.includes(searchValue)) {
              searchedUserId = searchValue;
              const userData = data[searchValue];
              
              userName.textContent = userData.nickname || 'Unknown User';
              userRole.textContent = userData.role || 'User';
              avatar.innerHTML = `<img src="${userData.avatar || 'https://via.placeholder.com/80'}" alt="User Avatar">`;
              
              userCard.classList.add('show');
              tokenAmount.value = '';
            } else {
              alert('User not found');
            }
          }, 800);
        } else {
          loadingSpinner.classList.remove('show');
          alert('No users found in database');
        }
      } catch (error) {
        loadingSpinner.classList.remove('show');
        console.error("Error getting data:", error);
        alert('Error searching for user');
      }
    });

    // Gift tokens
    giftBtn.addEventListener('click', async () => {
      if (!currentUserId) {
        alert('You must be logged in to send gifts');
        return;
      }

      if (!searchedUserId) {
        alert('Please search for a user first');
        return;
      }

      const amount = parseInt(tokenAmount.value);

      if (!amount || amount <= 0) {
        alert('Please enter a valid token amount');
        return;
      }

      if (!currentUserData || !currentUserData.tokens || currentUserData.tokens < amount) {
        alert('Insufficient tokens');
        return;
      }

      if (currentUserId === searchedUserId) {
        alert('You cannot gift tokens to yourself');
        return;
      }

      giftBtn.disabled = true;
      giftBtn.textContent = 'Sending...';

      try {
        // Get recipient's current tokens
        const recipientSnapshot = await get(child(ref(db), `users/${searchedUserId}`));
        
        if (!recipientSnapshot.exists()) {
          alert('Recipient user not found');
          giftBtn.disabled = false;
          giftBtn.textContent = ' Send Gift';
          return;
        }

        const recipientData = recipientSnapshot.val();
        const recipientTokens = recipientData.tokens || 0;

        // Update both users' tokens
        const updates = {};
        updates[`users/${currentUserId}/tokens`] = currentUserData.tokens - amount;
        updates[`users/${searchedUserId}/tokens`] = recipientTokens + amount;

        await update(ref(db), updates);

        // Update local data
        currentUserData.tokens -= amount;

        alert(`Successfully gifted ${amount} tokens to ${recipientData.nickname}! ðŸŽ‰`);
        tokenAmount.value = '';
        giftBtn.disabled = false;
        giftBtn.textContent = 'ðŸŽ Send Gift';
        
      } catch (error) {
        console.error("Error sending gift:", error);
        alert('Failed to send gift. Please try again.');
        giftBtn.disabled = false;
        giftBtn.textContent = 'ðŸŽ Send Gift';
      }
    });
  </script>
</body>
</html>