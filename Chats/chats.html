<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - BlackBox</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', sans-serif;
      }
      
      body {
        background: #0a0a0a;
        color: #e0e0e0;
        height: 100%;
        min-height: 100vh;
        overflow: hidden;
        margin: 0;
      }
      
      html {
        height: 100%;
      }
      
      .chat-container {
        display: flex;
        height: 100vh;
        min-height: 600px;
      }
      
      /* Sidebar */
      .sidebar {
        width: 380px;
        background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
        border-right: 1px solid #2a2a2a;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      
      .sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 200px;
        background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.03), transparent);
        pointer-events: none;
      }
      
      .sidebar-header {
        padding: 28px 24px;
        border-bottom: 1px solid #2a2a2a;
        position: relative;
        z-index: 2;
      }
      
      .sidebar-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      
      .sidebar-title h1 {
        font-size: 2em;
        font-weight: 900;
        background: linear-gradient(135deg, #ffffff, #888);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1.5px;
      }
      
      .new-chat-btn {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #ffffff, #e0e0e0);
        border: none;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(255, 255, 255, 0.1);
      }
      
      .new-chat-btn:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 8px 24px rgba(255, 255, 255, 0.2);
      }
      
      .new-chat-btn svg {
        width: 22px;
        height: 22px;
        color: #000;
      }
      
      .search-bar {
        position: relative;
      }
      
      .search-input {
        width: 100%;
        padding: 14px 18px 14px 48px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid #2a2a2a;
        border-radius: 14px;
        color: #ffffff;
        font-size: 0.95em;
        transition: all 0.3s ease;
      }
      
      .search-input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.06);
        border-color: #4a4a4a;
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.03);
      }
      
      .search-input::placeholder {
        color: #666;
      }
      
      .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
      }
      
      .search-icon svg {
        width: 20px;
        height: 20px;
        color: #666;
      }
      
      .tabs {
        display: flex;
        gap: 8px;
        padding: 16px 24px 0;
        border-bottom: 1px solid #2a2a2a;
      }
      
      .tab {
        flex: 1;
        padding: 12px;
        background: transparent;
        border: none;
        color: #666;
        font-weight: 600;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 2px solid transparent;
        position: relative;
      }
      
      .tab:hover {
        color: #aaa;
      }
      
      .tab.active {
        color: #fff;
        border-bottom-color: #fff;
      }
      
      .tab .badge {
        position: absolute;
        top: 8px;
        right: 12px;
        background: linear-gradient(135deg, #ff0050, #ff4081);
        color: #fff;
        font-size: 0.7em;
        font-weight: 700;
        padding: 3px 7px;
        border-radius: 10px;
        min-width: 20px;
        text-align: center;
      }
      
      .chat-list {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
      }
      
      /* Chat Item with Unread Indicator */
      .chat-item {
        padding: 16px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid transparent;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        gap: 14px;
        align-items: center;
        position: relative;
        overflow: hidden;
      }
      
      .chat-item.unread {
        background: rgba(0, 255, 127, 0.05);
        border-color: rgba(0, 255, 127, 0.2);
      }
      
      .chat-item.unread::after {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 70%;
        background: linear-gradient(180deg, #00ff7f, #00cc66);
        border-radius: 0 4px 4px 0;
        box-shadow: 0 0 12px rgba(0, 255, 127, 0.4);
      }
      
      .chat-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .chat-item:hover::before {
        opacity: 1;
      }
      
      .chat-item:hover {
        background: rgba(255, 255, 255, 0.04);
        border-color: #2a2a2a;
        transform: translateX(4px);
      }
      
      .chat-item.active {
        background: rgba(255, 255, 255, 0.08);
        border-color: #3a3a3a;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      }
      
      .chat-avatar {
        width: 54px;
        height: 54px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
        border: 3px solid #3a3a3a;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
      }
      
      .chat-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .chat-avatar svg {
        width: 26px;
        height: 26px;
        color: #666;
      }
      
      .online-indicator {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 14px;
        height: 14px;
        background: #00ff7f;
        border: 3px solid #1a1a1a;
        border-radius: 50%;
        box-shadow: 0 0 12px rgba(0, 255, 127, 0.5);
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% {
          box-shadow: 0 0 12px rgba(0, 255, 127, 0.5);
        }
        50% {
          box-shadow: 0 0 20px rgba(0, 255, 127, 0.8);
        }
      }
      
      .chat-info {
        flex: 1;
        min-width: 0;
      }
      
      .chat-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      
      .chat-name {
        font-weight: 700;
        color: #ffffff;
        font-size: 0.95em;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 150px;
      }
      
      .chat-time {
        font-size: 0.75em;
        color: #666;
        font-weight: 500;
      }
      
      .chat-item.unread .chat-time {
        color: #00ff7f;
        font-weight: 700;
      }
      
      .chat-preview {
        font-size: 0.88em;
        color: #888;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .chat-preview.unread {
        color: #fff;
        font-weight: 600;
      }
      
      .chat-item.unread .chat-preview {
        color: #00ff7f;
      }
      
     .unread-badge {
        background:rgb(222, 41, 41);
        color:white;
        font-size: 0.7em;
        font-weight: 700;
        padding: 4px 9px;
        border-radius: 12px;
        margin-left: auto;
        flex-shrink: 0;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        
      }
      
      /* Typing Indicator in Chat List */
      .typing-indicator-mini {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 2px 0;
      }
      
      .typing-indicator-mini span {
        width: 4px;
        height: 4px;
        background: #00ff7f;
        border-radius: 50%;
        animation: typingBounce 1.4s infinite ease-in-out;
      }
      
      .typing-indicator-mini span:nth-child(1) {
        animation-delay: 0s;
      }
      
      .typing-indicator-mini span:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .typing-indicator-mini span:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      @keyframes typingBounce {
        0%, 60%, 100% {
          transform: translateY(0);
          opacity: 0.7;
        }
        30% {
          transform: translateY(-6px);
          opacity: 1;
        }
      }
      
      /* Request Item */
      .request-item {
        padding: 18px;
        margin-bottom: 12px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid #2a2a2a;
        border-radius: 16px;
        display: flex;
        gap: 14px;
        align-items: center;
        animation: slideIn 0.3s ease;
      }
      
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      
      .request-info {
        flex: 1;
        min-width: 0;
      }
      
      .request-name {
        font-weight: 700;
        color: #ffffff;
        font-size: 1em;
        margin-bottom: 4px;
      }
      
      .request-message {
        font-size: 0.85em;
        color: #888;
      }
      
      .request-actions {
        display: flex;
        gap: 8px;
      }
      
      .request-btn {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .accept-btn {
        background: linear-gradient(135deg, #00ff7f, #00cc66);
      }
      
      .accept-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 16px rgba(0, 255, 127, 0.3);
      }
      
      .reject-btn {
        background: rgba(255, 0, 80, 0.15);
        border: 1px solid rgba(255, 0, 80, 0.3);
      }
      
      .reject-btn:hover {
        background: rgba(255, 0, 80, 0.25);
        transform: scale(1.1);
      }
      
      .request-btn svg {
        width: 18px;
        height: 18px;
        color: #fff;
      }
      
      /* Main Chat Area */
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #0a0a0a;
        position: relative;
      }
      
      .chat-main::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
          radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.02), transparent 40%),
          radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.02), transparent 40%);
        pointer-events: none;
      }
      
      .chat-header {
        padding: 28px 36px;
        border-bottom: 1px solid #2a2a2a;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
        position: relative;
        z-index: 10;
      }
      
      .chat-header-left {
        display: flex;
        align-items: center;
        gap: 18px;
      }
      
      .current-chat-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
        border: 3px solid #3a3a3a;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }
      
      .current-chat-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .current-chat-avatar svg {
        width: 28px;
        height: 28px;
        color: #666;
      }
      
      .current-chat-info h2 {
        font-size: 1.3em;
        font-weight: 800;
        color: #ffffff;
        margin-bottom: 4px;
        letter-spacing: -0.5px;
      }
      
      .current-chat-status {
        font-size: 0.88em;
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 20px;
      }
      
      .current-chat-status .status-text {
        color: #00ff7f;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .current-chat-status .status-text::before {
        content: '';
        width: 8px;
        height: 8px;
        background: #00ff7f;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
      }
      
      .current-chat-status.offline .status-text {
        color: #666;
      }
      
      .current-chat-status.offline .status-text::before {
        background: #666;
        animation: none;
      }
      
      /* Typing Indicator in Header */
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 0;
      }
      
      .typing-indicator span {
        width: 6px;
        height: 6px;
        background: #00ff7f;
        border-radius: 50%;
        animation: typingWave 1.4s infinite ease-in-out;
      }
      
      .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
      }
      
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      @keyframes typingWave {
        0%, 60%, 100% {
          transform: scale(0.8) translateY(0);
          opacity: 0.5;
        }
        30% {
          transform: scale(1.2) translateY(-4px);
          opacity: 1;
        }
      }
      
      .chat-header-actions {
        display: flex;
        gap: 12px;
      }
      
      .icon-btn {
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: #3a3a3a;
        transform: translateY(-2px);
      }
      
      .icon-btn svg {
        width: 22px;
        height: 22px;
        color: #888;
      }
      
      /* Messages Area */
      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 36px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
        z-index: 1;
      }
      
      .message {
        display: flex;
        gap: 12px;
        max-width: 65%;
        animation: messageSlide 0.4s ease;
      }
      
      @keyframes messageSlide {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .message.sent {
        margin-left: auto;
        flex-direction: row-reverse;
      }
      
      .message-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
        border: 2px solid #3a3a3a;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        overflow: hidden;
      }
      
      .message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .message-avatar svg {
        width: 20px;
        height: 20px;
        color: #666;
      }
      
      .message-content {
        flex: 1;
      }
      
      .message-bubble {
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid #2a2a2a;
        border-radius: 20px 20px 20px 4px;
        color: #e0e0e0;
        font-size: 0.95em;
        line-height: 1.6;
        margin-bottom: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      
      .message.sent .message-bubble {
        background: linear-gradient(135deg, #ffffff, #f0f0f0);
        color: #0a0a0a;
        border: none;
        border-radius: 20px 20px 4px 20px;
        box-shadow: 0 4px 16px rgba(255, 255, 255, 0.1);
      }
      
      .message-footer {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75em;
        color: #666;
        padding: 0 8px;
        font-weight: 500;
      }
      
      .message.sent .message-footer {
        justify-content: flex-end;
      }
      
      /* Read Receipts (Ticks) */
      .message-status {
        display: inline-flex;
        align-items: center;
        gap: 2px;
      }
      
      .tick-icon {
        width: 16px;
        height: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      
      .tick-icon svg {
        width: 14px;
        height: 14px;
        stroke-width: 3;
      }
      
      /* Single tick - sent */
      .message-status.sent .tick-icon svg {
        color: #666;
      }
      
      /* Double tick - delivered */
      .message-status.delivered .tick-icon {
        margin-left: -6px;
      }
      
      .message-status.delivered .tick-icon svg {
        color: #888;
      }
      
      .message-status.delivered .tick-icon:first-child {
        margin-left: 0;
      }
      
      /* Double tick - read (green) */
      .message-status.read .tick-icon {
        margin-left: -6px;
      }
      
      .message-status.read .tick-icon svg {
        color: #00ff7f;
      }
      
      .message-status.read .tick-icon:first-child {
        margin-left: 0;
      }
      
      .date-divider {
        text-align: center;
        margin: 24px 0;
        position: relative;
      }
      
      .date-divider::before,
      .date-divider::after {
        content: '';
        position: absolute;
        top: 50%;
        width: 40%;
        height: 1px;
        background: linear-gradient(to right, transparent, #2a2a2a, transparent);
      }
      
      .date-divider::before {
        left: 0;
      }
      
      .date-divider::after {
        right: 0;
      }
      
      .date-divider span {
        background: #0a0a0a;
        padding: 8px 20px;
        border-radius: 24px;
        font-size: 0.8em;
        color: #888;
        border: 1px solid #2a2a2a;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
        position: relative;
        z-index: 1;
      }
      
      /* Input Area */
      .chat-input-container {
        padding: 24px 36px;
        border-top: 1px solid #2a2a2a;
        background: linear-gradient(180deg, #0f0f0f 0%, #1a1a1a 100%);
        position: relative;
        z-index: 10;
      }
      
      .chat-input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid #2a2a2a;
        border-radius: 16px;
        padding: 8px;
        transition: all 0.3s ease;
      }
      
      .chat-input-wrapper:focus-within {
        background: rgba(255, 255, 255, 0.06);
        border-color: #4a4a4a;
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.03);
      }
      
      .input-actions {
        display: flex;
        gap: 4px;
      }
      
      .input-icon-btn {
        width: 40px;
        height: 40px;
        background: transparent;
        border: none;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .input-icon-btn:hover {
        background: rgba(255, 255, 255, 0.06);
      }
      
      .input-icon-btn svg {
        width: 20px;
        height: 20px;
        color: #888;
      }
      
      .message-input {
        flex: 1;
        padding: 12px 8px;
        background: transparent;
        border: none;
        color: #ffffff;
        font-size: 0.95em;
        resize: none;
        max-height: 120px;
        min-height: 40px;
      }
      
      .message-input:focus {
        outline: none;
      }
      
      .message-input::placeholder {
        color: #666;
      }
      
      .send-btn {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #ffffff, #e0e0e0);
        border: none;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(255, 255, 255, 0.1);
      }
      
      .send-btn:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 8px 24px rgba(255, 255, 255, 0.2);
      }
      
      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .send-btn svg {
        width: 20px;
        height: 20px;
        color: #000;
      }
      
      /* Empty State */
      .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px;
        color: #666;
      }
      
      .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 24px;
        opacity: 0.3;
      }
      
      .empty-state h3 {
        font-size: 1.5em;
        font-weight: 700;
        color: #888;
        margin-bottom: 8px;
      }
      
      .empty-state p {
        font-size: 0.95em;
        color: #666;
      }
      
      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(12px);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }
      
      .modal-overlay.active {
        display: flex;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .modal-content {
        background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
        border: 1px solid #2a2a2a;
        border-radius: 24px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        animation: slideUp 0.3s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
      }
      
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .modal-header {
        padding: 32px;
        border-bottom: 1px solid #2a2a2a;
      }
      
      .modal-header h2 {
        font-size: 1.8em;
        font-weight: 800;
        color: #ffffff;
        letter-spacing: -1px;
      }
      
      .modal-close {
        position: absolute;
        top: 24px;
        right: 24px;
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #2a2a2a;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: #ff4444;
        transform: rotate(90deg);
      }
      
      .modal-close svg {
        width: 20px;
        height: 20px;
        color: #fff;
      }
      
      .modal-body {
        padding: 24px 32px 32px;
      }
      
      .user-item {
        padding: 18px;
        margin-bottom: 12px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid #2a2a2a;
        border-radius: 16px;
        display: flex;
        gap: 14px;
        align-items: center;
        transition: all 0.3s ease;
      }
      
      .user-item:hover {
        background: rgba(255, 255, 255, 0.04);
        border-color: #3a3a3a;
      }
      
      .user-item-info {
        flex: 1;
        min-width: 0;
        overflow: hidden;
      }
      
      .user-item-name {
        font-weight: 700;
        color: #ffffff;
        font-size: 0.95em;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .user-item-status {
        font-size: 0.8em;
        color: #888;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .connect-btn {
        padding: 10px 18px;
        background: linear-gradient(135deg, #ffffff, #e0e0e0);
        border: none;
        border-radius: 10px;
        color: #000;
        font-weight: 700;
        font-size: 0.82em;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
        flex-shrink: 0;
      }
      
      .connect-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2);
      }
      
      .connect-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .connect-btn svg {
        width: 16px;
        height: 16px;
      }
      
      /* Toast */
      .toast {
        position: fixed;
        bottom: 32px;
        right: 32px;
        background: linear-gradient(135deg, #1a1a1a, #0f0f0f);
        border: 1px solid #2a2a2a;
        border-left: 4px solid #00ff7f;
        border-radius: 16px;
        padding: 18px 24px;
        color: #fff;
        font-weight: 600;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
        z-index: 10000;
        animation: slideInRight 0.4s ease;
        display: flex;
        align-items: center;
        gap: 14px;
        min-width: 280px;
      }
      
      .toast.error {
        border-left-color: #ff0050;
      }
      
      @keyframes slideInRight {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      .toast svg {
        width: 22px;
        height: 22px;
        flex-shrink: 0;
      }
      
      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      
      ::-webkit-scrollbar-thumb {
        background: #2a2a2a;
        border-radius: 4px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: #3a3a3a;
      }
      
      /* Mobile menu button */
      .mobile-menu-btn {
        display: none;
        position: fixed;
        top: 16px;
        left: 16px;
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #1a1a1a, #0f0f0f);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        z-index: 101;
        cursor: pointer;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      }
      
      .mobile-menu-btn svg {
        width: 24px;
        height: 24px;
        color: #fff;
      }
      
      /* Responsive */
      @media (max-width: 1024px) {
        .sidebar {
          width: 320px;
        }
      }
      
      @media (max-width: 768px) {
        html, body {
          height: 100%;
          overflow: hidden;
        }
        
        .chat-container {
          height: 100%;
          min-height: 100vh;
        }
        
        .sidebar {
          width: 100%;
          position: absolute;
          z-index: 100;
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          height: 100%;
        }
      
        .sidebar.active {
          transform: translateX(0);
        }
      
        .chat-main {
          width: 100%;
        }
      
        .message {
          max-width: 85%;
        }
      
        .messages-container {
          padding: 24px 16px;
          padding-bottom: 120px;
        }
      
        .chat-input-container {
          padding: 16px;
        }
      
        .chat-header {
          padding: 20px 16px;
        }
      
        .toast {
          bottom: 20px;
          right: 20px;
          left: 20px;
          min-width: auto;
        }
        
        .modal-content {
          max-height: 85vh;
        }
      
        .mobile-menu-btn {
          display: flex;
        }
        
        .sidebar-header {
          padding-top: 70px;
        }
      }
      
      @media(min-width:500px){
        #mobileMenuBtn{
          margin-top:3%;
        }
      
        #sidebar_title{
          margin-top:12%;
        }
      
        #newChatModal{
          margin-top: 6%;
        }
      }

      /* Unread message preview - GREEN */
.chat-preview.unread {
  color: #00ff7f !important;
  font-weight: 600;
}

/* Unread badge */
.unread-badge {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  background: #00ff7f;
  color: #0a0e27;
  border-radius: 50%;
  min-width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
  padding: 0 6px;
}

/* Typing indicator mini (in chat list) */
.typing-indicator-mini {
  display: inline-flex;
  gap: 3px;
  margin-right: 5px;
  vertical-align: middle;
}

.typing-indicator-mini span {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: #00ff7f;
  animation: typingBounce 1.4s infinite ease-in-out;
}

.typing-indicator-mini span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator-mini span:nth-child(3) {
  animation-delay: 0.4s;
}

/* Typing indicator (in header) */
.typing-indicator {
  display: flex;
  gap: 4px;
  align-items: center;
}

.typing-indicator span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #00ff7f;
  animation: typingPulse 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typingBounce {
  0%, 60%, 100% { 
    transform: translateY(0); 
    opacity: 0.7;
  }
  30% { 
    transform: translateY(-6px); 
    opacity: 1;
  }
}

@keyframes typingPulse {
  0%, 60%, 100% { 
    opacity: 0.3; 
    transform: scale(0.8); 
  }
  30% { 
    opacity: 1; 
    transform: scale(1.3); 
  }
}

/* Message status ticks */
.message-status {
  display: inline-flex;
  gap: -4px;
  margin-left: 6px;
  align-items: center;
}

.message-status svg {
  width: 16px;
  height: 16px;
}

/* Single tick - gray */
.message-status.sent svg {
  stroke: #8e9aaf;
}

/* Double ticks - gray */
.message-status.delivered svg {
  stroke: #8e9aaf;
}

/* Double ticks - green */
.message-status.read svg {
  stroke: #00ff7f;
}

/* Active chat */
.chat-item.active {
  background: rgba(0, 255, 127, 0.1);
  border-left: 3px solid #00ff7f;
}

/* Message footer */
.message-footer {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 4px;
}

.message-time {
  font-size: 11px;
  opacity: 0.7;
}
  </style>
</head>
<body>

  <div class="modal-overlay" id="newChatModal">
    <div class="modal-content">
      <div class="modal-close" id="closeModal">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </div>
      <div class="modal-header">
        <h2>Connect with Users</h2>
      </div>
      <div class="modal-body">
        <div class="search-bar" style="margin-bottom: 24px;">
          <div class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          </div>
          <input type="text" class="search-input" id="modalSearchInput" placeholder="Search users...">
        </div>
        <div id="availableUsers"></div>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <button class="mobile-menu-btn" id="mobileMenuBtn">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg> 
    </button>
    
    <div class="sidebar" id="chatSidebar">
      <div class="sidebar-header">
        <div class="sidebar-title" id="sidebar_title">
          <h1>Messages</h1>
          <button class="new-chat-btn" id="newChatBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
        <div class="search-bar">
          <div class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          </div>
          <input type="text" class="search-input" id="searchInput" placeholder="Search conversations...">
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="chats">
          Chats
        </button>
        <button class="tab" data-tab="requests">
          Requests
          <span class="badge" id="requestsBadge" style="display: none;">0</span>
        </button>
        <button class="tab" data-tab="discover">
          Discover
        </button>
      </div>

      <div class="chat-list" id="chatList"></div>
    </div>

    <div class="chat-main">
      <div class="chat-header" id="chatHeader" style="display: none;">
        <div class="chat-header-left">
          <div class="current-chat-avatar" id="currentChatAvatar">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <div class="online-indicator"></div>
          </div>
          <div class="current-chat-info">
            <h2 id="currentChatName">Select a chat</h2>
            <div class="current-chat-status" id="currentChatStatus">Offline</div>
          </div>
        </div>
        <div class="chat-header-actions">
          <button class="icon-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
          </button>
          <button class="icon-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
          </button>
        </div>
      </div>

      <div class="messages-container" id="messagesContainer">
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <h3>No conversation selected</h3>
          <p>Choose a conversation from the sidebar or start a new one</p>
        </div>
      </div>

      <div class="chat-input-container" id="chatInputContainer" style="display: none;">
        <div class="chat-input-wrapper">
          <div class="input-actions">
            <button class="input-icon-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
            </button>
            <button class="input-icon-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
            </button>
          </div>
          <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
          <button class="send-btn" id="sendBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
          
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { ref, get, set, push, remove, onValue, getDatabase, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBsOwXNtfaWwEh3qaM0suXafOg6CYLzDC8",
      authDomain: "uamtv-c031c.firebaseapp.com",
      databaseURL: "https://uamtv-c031c-default-rtdb.firebaseio.com",
      projectId: "uamtv-c031c",
      storageBucket: "uamtv-c031c.firebasestorage.app",
      messagingSenderId: "9790917697",
      appId: "1:9790917697:web:275c8347b7688e0ac38ac0",
      measurementId: "G-RSXW1XBVQZ"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase();
    
    let currentUser = null;
    let allUsers = {};
    let friendRequests = [];
    let friends = {};
    let activeChat = null;
    let currentTab = 'chats';
    let sentRequests = {};
    let typingTimeouts = {};
    let chatRoomsData = {};
    let messagesListeners = {};
    
    const newChatModal = document.getElementById('newChatModal');
    const closeModal = document.getElementById('closeModal');
    const newChatBtn = document.getElementById('newChatBtn');
    const chatList = document.getElementById('chatList');
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatHeader = document.getElementById('chatHeader');
    const chatInputContainer = document.getElementById('chatInputContainer');
    const availableUsers = document.getElementById('availableUsers');
    const modalSearchInput = document.getElementById('modalSearchInput');
    const searchInput = document.getElementById('searchInput');
    const chatSidebar = document.getElementById('chatSidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    
    // Toast notification
    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) existingToast.remove();
    
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          ${type === 'success' 
            ? '<polyline points="20 6 9 17 4 12"/>' 
            : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'
          }
        </svg>
        <span>${message}</span>
      `;
      document.body.appendChild(toast);
    
      setTimeout(() => {
        toast.style.animation = 'slideInRight 0.4s ease reverse';
        setTimeout(() => toast.remove(), 400);
      }, 3000);
    }
    
    // Format time helper
    function formatTime(date) {
      const now = new Date();
      const diff = now - date;
      const hours = date.getHours();
      const minutes = date.getMinutes().toString().padStart(2, '0');
      
      // Less than 1 minute ago
      if (diff < 60000) return 'Now';
      
      // Today
      if (date.toDateString() === now.toDateString()) {
        return `${hours % 12 || 12}:${minutes} ${hours >= 12 ? 'PM' : 'AM'}`;
      }
      
      // Yesterday
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
      }
      
      // This week
      if (diff < 7 * 24 * 60 * 60 * 1000) {
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        return days[date.getDay()];
      }
      
      // Older
      return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
    }
    
    // Format message date
    function formatMessageDate(date) {
      const now = new Date();
      const today = now.toDateString();
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (date.toDateString() === today) {
        return 'Today';
      } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
      } else {
        return date.toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      }
    }
    
    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        setUserOnlineStatus(true);
        initializeChat();
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
          setUserOnlineStatus(false);
        });
      } else {
        showToast('Please log in to use chat', 'error');
        setTimeout(() => window.location.href = '/login.html', 2000);
      }
    });
    
    // Set user online status
    function setUserOnlineStatus(isOnline) {
      if (!currentUser) return;
      
      update(ref(db, `users/${currentUser.uid}`), {
        status: isOnline ? 'online' : 'offline',
        lastSeen: Date.now()
      });
    }
    
    function initializeChat() {
      loadUsers();
      loadFriendRequests();
      loadFriends();
      loadSentRequests();
      setupEventListeners();
      renderCurrentTab();
    }
    
    // Load all users
    function loadUsers() {
      onValue(ref(db, 'users'), (snapshot) => {
        if (snapshot.exists()) {
          allUsers = snapshot.val();
          if (currentTab === 'chats') renderChats();
        }
      });
    }
    
    // Load sent requests
    function loadSentRequests() {
      onValue(ref(db, 'friendRequests'), (snapshot) => {
        sentRequests = {};
        if (snapshot.exists()) {
          const allRequests = snapshot.val();
          Object.keys(allRequests).forEach(userId => {
            Object.keys(allRequests[userId]).forEach(requestId => {
              const request = allRequests[userId][requestId];
              if (request.from === currentUser.uid && request.status === 'pending') {
                sentRequests[userId] = true;
              }
            });
          });
        }
        if (currentTab === 'discover') renderDiscover();
      });
    }
    
    // Load friend requests
    function loadFriendRequests() {
      onValue(ref(db, `friendRequests/${currentUser.uid}`), (snapshot) => {
        friendRequests = [];
        if (snapshot.exists()) {
          const requests = snapshot.val();
          Object.keys(requests).forEach(requestId => {
            if (requests[requestId].status === 'pending') {
              friendRequests.push({
                id: requestId,
                ...requests[requestId]
              });
            }
          });
        }
        updateRequestsBadge();
        if (currentTab === 'requests') renderRequests();
      });
    }
    
    // Load friends and chat rooms
    function loadFriends() {
      onValue(ref(db, `friends/${currentUser.uid}`), (snapshot) => {
        friends = {};
        if (snapshot.exists()) {
          friends = snapshot.val();
          
          // Load chat room data for each friend
          Object.keys(friends).forEach(friendId => {
            const chatRoomId = friends[friendId].chatRoomId;
            loadChatRoomData(chatRoomId);
            listenToTyping(chatRoomId, friendId);
          });
        }
        if (currentTab === 'chats') renderChats();
      });
    }
    
    // Load chat room data (last message, unread count)
    function loadChatRoomData(chatRoomId) {
      onValue(ref(db, `chatRooms/${chatRoomId}`), (snapshot) => {
        if (snapshot.exists()) {
          chatRoomsData[chatRoomId] = snapshot.val();
          if (currentTab === 'chats') renderChats();
        }
      });
    }
    
    // Listen to typing status
    function listenToTyping(chatRoomId, friendId) {
      onValue(ref(db, `typing/${chatRoomId}/${friendId}`), (snapshot) => {
        const isTyping = snapshot.exists() && snapshot.val().isTyping;
        
        // Update chat list typing indicator
        const chatItem = document.querySelector(`[data-chat-room-id="${chatRoomId}"]`);
        if (chatItem && !chatItem.classList.contains('active')) {
          const preview = chatItem.querySelector('.chat-preview');
          if (preview) {
            if (isTyping) {
              preview.innerHTML = `
                <div class="typing-indicator-mini">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
                typing...
              `;
              preview.style.color = '#00ff7f';
            } else {
              // Restore original preview
              if (chatRoomsData[chatRoomId]?.lastMessage) {
                const lastMsg = chatRoomsData[chatRoomId].lastMessage;
                const unreadCount = chatRoomsData[chatRoomId]?.unreadCount?.[currentUser.uid] || 0;
                preview.textContent = lastMsg.senderId === currentUser.uid 
                  ? `You: ${lastMsg.text}` 
                  : lastMsg.text;
                preview.style.color = unreadCount > 0 ? '#00ff7f' : '';
                if (unreadCount > 0) {
                  preview.classList.add('unread');
                } else {
                  preview.classList.remove('unread');
                }
              } else {
                preview.textContent = 'Start a conversation';
                preview.style.color = '';
                preview.classList.remove('unread');
              }
            }
          }
        }
        
        // Update header typing indicator if this is active chat
        if (activeChat?.chatRoomId === chatRoomId) {
          const statusEl = document.getElementById('currentChatStatus');
          let typingIndicator = statusEl.querySelector('.typing-indicator');
          let statusText = statusEl.querySelector('.status-text');
          
          if (isTyping) {
            if (!typingIndicator) {
              typingIndicator = document.createElement('div');
              typingIndicator.className = 'typing-indicator';
              typingIndicator.innerHTML = '<span></span><span></span><span></span>';
              statusEl.appendChild(typingIndicator);
            }
            if (statusText) statusText.style.display = 'none';
            typingIndicator.style.display = 'flex';
          } else {
            if (typingIndicator) typingIndicator.style.display = 'none';
            if (statusText) statusText.style.display = 'block';
          }
        }
      });
    }
    
    // Set typing status
    function setTypingStatus(isTyping) {
      if (!activeChat) return;
      
      const typingRef = ref(db, `typing/${activeChat.chatRoomId}/${currentUser.uid}`);
      
      if (isTyping) {
        set(typingRef, {
          isTyping: true,
          timestamp: Date.now()
        });
        
        // Clear existing timeout
        if (typingTimeouts[activeChat.chatRoomId]) {
          clearTimeout(typingTimeouts[activeChat.chatRoomId]);
        }
        
        // Auto-clear typing status after 3 seconds
        typingTimeouts[activeChat.chatRoomId] = setTimeout(() => {
          remove(typingRef);
        }, 3000);
      } else {
        remove(typingRef);
        if (typingTimeouts[activeChat.chatRoomId]) {
          clearTimeout(typingTimeouts[activeChat.chatRoomId]);
        }
      }
    }
    
    // Update requests badge
    function updateRequestsBadge() {
      const badge = document.getElementById('requestsBadge');
      if (friendRequests.length > 0) {
        badge.textContent = friendRequests.length;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Mobile sidebar toggle
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', () => {
          chatSidebar.classList.toggle('active');
        });
        
        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 768 && 
              chatSidebar.classList.contains('active') && 
              !chatSidebar.contains(e.target) && 
              !mobileMenuBtn.contains(e.target)) {
            chatSidebar.classList.remove('active');
          }
        });
      }
    
      newChatBtn.addEventListener('click', () => {
        newChatModal.classList.add('active');
        renderAvailableUsers();
      });
    
      closeModal.addEventListener('click', () => {
        newChatModal.classList.remove('active');
      });
    
      newChatModal.addEventListener('click', (e) => {
        if (e.target === newChatModal) {
          newChatModal.classList.remove('active');
        }
      });
    
      modalSearchInput.addEventListener('input', (e) => {
        renderAvailableUsers(e.target.value.toLowerCase());
      });
    
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    
      // Typing indicator
      let typingTimer;
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
        
        // Typing status
        clearTimeout(typingTimer);
        setTypingStatus(true);
        
        typingTimer = setTimeout(() => {
          setTypingStatus(false);
        }, 1000);
      });
    
      messageInput.addEventListener('blur', () => {
        setTypingStatus(false);
      });
    
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentTab = tab.dataset.tab;
          renderCurrentTab();
        });
      });
    
      searchInput.addEventListener('input', (e) => {
        renderCurrentTab(e.target.value.toLowerCase());
      });
    }
    
    // Render current tab
    function renderCurrentTab(searchQuery = '') {
      if (currentTab === 'chats') {
        renderChats(searchQuery);
      } else if (currentTab === 'requests') {
        renderRequests();
      } else if (currentTab === 'discover') {
        renderDiscover(searchQuery);
      }
    }
    
    // Render Discover tab
    function renderDiscover(searchQuery = '') {
      chatList.innerHTML = '';
      
      const userIds = Object.keys(allUsers).filter(userId => {
        if (userId === currentUser.uid) return false;
        if (friends[userId]) return false;
        
        const user = allUsers[userId];
        if (searchQuery) {
          return (user.nickname || '').toLowerCase().includes(searchQuery) ||
                 (user.role || '').toLowerCase().includes(searchQuery);
        }
        return true;
      });
    
      if (userIds.length === 0) {
        chatList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/></svg>
            <h3>No users found</h3>
            <p>All available users are already your friends</p>
          </div>
        `;
        return;
      }
    
      userIds.forEach(userId => {
        const user = allUsers[userId];
        const item = document.createElement('div');
        item.className = 'user-item';
        
        const avatarHtml = user.avatar 
          ? `<img src="${user.avatar}" alt="${user.nickname}">`
          : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
        
        const isPending = sentRequests[userId];
        
        item.innerHTML = `
          <div class="chat-avatar">
            ${avatarHtml}
            ${user.status === 'online' ? '<div class="online-indicator"></div>' : ''}
          </div>
          <div class="user-item-info">
            <div class="user-item-name">${user.nickname || 'Anonymous'}</div>
            <div class="user-item-status">${user.role || 'User'}</div>
          </div>
          <button class="connect-btn" data-user-id="${userId}" ${isPending ? 'disabled' : ''} style="${isPending ? 'background: rgba(0, 255, 127, 0.15); color: #00ff7f; cursor: not-allowed;' : ''}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
            ${isPending ? 'Pending' : 'Connect'}
          </button>
        `;
        
        if (!isPending) {
          const connectBtn = item.querySelector('.connect-btn');
          connectBtn.addEventListener('click', () => sendFriendRequest(userId, connectBtn));
        }
        
        chatList.appendChild(item);
      });
    }
    
    // Render available users in modal
    function renderAvailableUsers(searchQuery = '') {
      availableUsers.innerHTML = '';
      
      const userIds = Object.keys(allUsers).filter(userId => {
        if (userId === currentUser.uid) return false;
        if (friends[userId]) return false;
        
        const user = allUsers[userId];
        if (searchQuery) {
          return (user.nickname || '').toLowerCase().includes(searchQuery);
        }
        return true;
      });
    
      if (userIds.length === 0) {
        availableUsers.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/></svg>
            <h3>No users found</h3>
            <p>All available users are already your friends</p>
          </div>
        `;
        return;
      }
    
      userIds.forEach(userId => {
        const user = allUsers[userId];
        const item = document.createElement('div');
        item.className = 'user-item';
        
        const avatarHtml = user.avatar 
          ? `<img src="${user.avatar}" alt="${user.nickname}">`
          : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
        
        const isPending = sentRequests[userId];
        
        item.innerHTML = `
          <div class="chat-avatar">
            ${avatarHtml}
            ${user.status === 'online' ? '<div class="online-indicator"></div>' : ''}
          </div>
          <div class="user-item-info">
            <div class="user-item-name">${user.nickname || 'Anonymous'}</div>
            <div class="user-item-status">${user.role || 'User'}</div>
          </div>
          <button class="connect-btn" data-user-id="${userId}" ${isPending ? 'disabled' : ''}>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
            ${isPending ? 'Pending' : 'Connect'}
          </button>
        `;
        
        if (!isPending) {
          const connectBtn = item.querySelector('.connect-btn');
          connectBtn.addEventListener('click', () => sendFriendRequest(userId, connectBtn));
        }
        
        availableUsers.appendChild(item);
      });
    }
    
    // Send friend request
    async function sendFriendRequest(toUserId, button) {
      button.disabled = true;
      
      try {
        const requestId = push(ref(db, `friendRequests/${toUserId}`)).key;
        
        await set(ref(db, `friendRequests/${toUserId}/${requestId}`), {
          from: currentUser.uid,
          fromName: allUsers[currentUser.uid]?.nickname || 'Anonymous',
          fromAvatar: allUsers[currentUser.uid]?.avatar || null,
          status: 'pending',
          timestamp: Date.now()
        });
    
        button.textContent = 'Pending';
        button.style.background = 'rgba(0, 255, 127, 0.15)';
        button.style.color = '#00ff7f';
        button.style.cursor = 'not-allowed';
        
        showToast('Friend request sent!', 'success');
        newChatModal.classList.remove('active');
      } catch (error) {
        console.error('Error sending friend request:', error);
        showToast('Failed to send request', 'error');
        button.disabled = false;
      }
    }
    
    // Render friend requests
    function renderRequests() {
      chatList.innerHTML = '';
      
      if (friendRequests.length === 0) {
        chatList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            <h3>No friend requests</h3>
            <p>You don't have any pending friend requests</p>
          </div>
        `;
        return;
      }
    
      friendRequests.forEach(request => {
        const item = document.createElement('div');
        item.className = 'request-item';
        
        const avatarHtml = request.fromAvatar 
          ? `<img src="${request.fromAvatar}" alt="${request.fromName}">`
          : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
        
        item.innerHTML = `
          <div class="chat-avatar">
            ${avatarHtml}
          </div>
          <div class="request-info">
            <div class="request-name">${request.fromName}</div>
            <div class="request-message">wants to connect with you</div>
          </div>
          <div class="request-actions">
            <button class="request-btn accept-btn" data-request-id="${request.id}" data-from="${request.from}">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            </button>
            <button class="request-btn reject-btn" data-request-id="${request.id}">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
        `;
        
        item.querySelector('.accept-btn').addEventListener('click', (e) => {
          acceptFriendRequest(e.target.closest('button').dataset.requestId, e.target.closest('button').dataset.from);
        });
        
        item.querySelector('.reject-btn').addEventListener('click', (e) => {
          rejectFriendRequest(e.target.closest('button').dataset.requestId);
        });
        
        chatList.appendChild(item);
      });
    }
    
    // Accept friend request
    async function acceptFriendRequest(requestId, fromUserId) {
      try {
        const chatRoomId = [currentUser.uid, fromUserId].sort().join('_');
        
        await set(ref(db, `friends/${currentUser.uid}/${fromUserId}`), {
          chatRoomId,
          addedAt: Date.now()
        });
        
        await set(ref(db, `friends/${fromUserId}/${currentUser.uid}`), {
          chatRoomId,
          addedAt: Date.now()
        });
        
        await set(ref(db, `chatRooms/${chatRoomId}`), {
          participants: {
            [currentUser.uid]: true,
            [fromUserId]: true
          },
          createdAt: Date.now(),
          lastMessage: null,
          unreadCount: {
            [currentUser.uid]: 0,
            [fromUserId]: 0
          }
        });
        
        await remove(ref(db, `friendRequests/${currentUser.uid}/${requestId}`));
        
        showToast('Friend request accepted!', 'success');
        document.querySelector('[data-tab="chats"]').click();
      } catch (error) {
        console.error('Error accepting friend request:', error);
        showToast('Failed to accept request', 'error');
      }
    }
    
    // Reject friend request
    async function rejectFriendRequest(requestId) {
      try {
        await remove(ref(db, `friendRequests/${currentUser.uid}/${requestId}`));
        showToast('Friend request rejected', 'success');
      } catch (error) {
        console.error('Error rejecting friend request:', error);
        showToast('Failed to reject request', 'error');
      }
    }
    
    // Render chats (sorted by most recent, unread messages at top)
    function renderChats(searchQuery = '') {
      chatList.innerHTML = '';
      
      const friendIds = Object.keys(friends);
      
      if (friendIds.length === 0) {
        chatList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <h3>No conversations yet</h3>
            <p>Connect with users to start chatting</p>
          </div>
        `;
        return;
      }
    
      // Filter friends by search query
      let filteredFriends = friendIds.filter(friendId => {
        if (!searchQuery) return true;
        const friend = allUsers[friendId];
        return friend && (friend.nickname || '').toLowerCase().includes(searchQuery);
      });
    
      if (filteredFriends.length === 0) {
        chatList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <h3>No results found</h3>
            <p>Try searching for a different name</p>
          </div>
        `;
        return;
      }
    
      // Sort friends: unread first, then by most recent message
      const sortedFriends = filteredFriends.sort((a, b) => {
        const chatRoomA = friends[a].chatRoomId;
        const chatRoomB = friends[b].chatRoomId;
        const unreadA = chatRoomsData[chatRoomA]?.unreadCount?.[currentUser.uid] || 0;
        const unreadB = chatRoomsData[chatRoomB]?.unreadCount?.[currentUser.uid] || 0;
        
        // Unread messages come first
        if (unreadA > 0 && unreadB === 0) return -1;
        if (unreadB > 0 && unreadA === 0) return 1;
        
        // Then sort by most recent message
        const lastMsgA = chatRoomsData[chatRoomA]?.lastMessage?.timestamp || 0;
        const lastMsgB = chatRoomsData[chatRoomB]?.lastMessage?.timestamp || 0;
        return lastMsgB - lastMsgA;
      });
    
      sortedFriends.forEach(friendId => {
        const friend = allUsers[friendId];
        if (!friend) return;
        
        const chatRoomId = friends[friendId].chatRoomId;
        const roomData = chatRoomsData[chatRoomId] || {};
        const unreadCount = roomData.unreadCount?.[currentUser.uid] || 0;
        const hasUnread = unreadCount > 0;
        
        const item = document.createElement('div');
        item.className = `chat-item ${hasUnread ? 'unread' : ''} ${activeChat?.chatRoomId === chatRoomId ? 'active' : ''}`;
        item.dataset.chatRoomId = chatRoomId;
        item.dataset.friendId = friendId;
        
        const avatarHtml = friend.avatar 
          ? `<img src="${friend.avatar}" alt="${friend.nickname}">`
          : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
        
        let previewText = 'Start a conversation';
        let timeText = 'Now';
        
        if (roomData.lastMessage) {
          const lastMsg = roomData.lastMessage;
          previewText = lastMsg.senderId === currentUser.uid 
            ? `You: ${lastMsg.text}` 
            : lastMsg.text;
          timeText = formatTime(new Date(lastMsg.timestamp));
        }
        
        item.innerHTML = `
          <div class="chat-avatar">
            ${avatarHtml}
            ${friend.status === 'online' ? '<div class="online-indicator"></div>' : ''}
          </div>
          <div class="chat-info">
            <div class="chat-header-row">
              <div class="chat-name">${friend.nickname || 'Anonymous'}</div>
              <div class="chat-time">${timeText}</div>
            </div>
            <div class="chat-preview ${hasUnread ? 'unread' : ''}">${previewText}</div>
          </div>
          ${hasUnread ? `<span class="unread-badge">${unreadCount}</span>` : ''}
        `;
        
        item.addEventListener('click', () => openChat(chatRoomId, friendId, friend));
        chatList.appendChild(item);
      });
    }
    
    // Open chat
    function openChat(chatRoomId, friendId, friendData) {
      // Close mobile sidebar
      if (window.innerWidth <= 768) {
        chatSidebar.classList.remove('active');
      }
    
      activeChat = { chatRoomId, friendId, friendData };
      
      // Update active chat item in sidebar
      document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
      const activeItem = document.querySelector(`[data-chat-room-id="${chatRoomId}"]`);
      if (activeItem) activeItem.classList.add('active');
      
      // Show chat header and input
      chatHeader.style.display = 'flex';
      chatInputContainer.style.display = 'block';
      
      // Update header
      const currentChatName = document.getElementById('currentChatName');
      const currentChatStatus = document.getElementById('currentChatStatus');
      const currentChatAvatar = document.getElementById('currentChatAvatar');
      
      currentChatName.textContent = friendData.nickname || 'Anonymous';
      
      const avatarHtml = friendData.avatar 
        ? `<img src="${friendData.avatar}" alt="${friendData.nickname}">`
        : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
      
      currentChatAvatar.innerHTML = avatarHtml;
      if (friendData.status === 'online') {
        currentChatAvatar.innerHTML += '<div class="online-indicator"></div>';
      }
      
      // Update status
      currentChatStatus.className = `current-chat-status ${friendData.status === 'online' ? '' : 'offline'}`;
      currentChatStatus.innerHTML = `
        <div class="status-text">${friendData.status === 'online' ? 'Online' : 'Offline'}</div>
        <div class="typing-indicator" style="display: none;">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;
      
      // Mark messages as read
      markMessagesAsRead(chatRoomId);
      
      // Load messages
      loadMessages(chatRoomId);
      
      // Focus input
      messageInput.focus();
    }
    
    // Mark messages as read
    async function markMessagesAsRead(chatRoomId) {
      try {
        await update(ref(db, `chatRooms/${chatRoomId}/unreadCount`), {
          [currentUser.uid]: 0
        });
        
        // Update read status for all unread messages
        const messagesRef = ref(db, `messages/${chatRoomId}`);
        const snapshot = await get(messagesRef);
        
        if (snapshot.exists()) {
          const messages = snapshot.val();
          const updates = {};
          
          Object.keys(messages).forEach(msgId => {
            const msg = messages[msgId];
            if (msg.senderId !== currentUser.uid && msg.status !== 'read') {
              updates[`messages/${chatRoomId}/${msgId}/status`] = 'read';
              updates[`messages/${chatRoomId}/${msgId}/readAt`] = Date.now();
            }
          });
          
          if (Object.keys(updates).length > 0) {
            await update(ref(db), updates);
          }
        }
      } catch (error) {
        console.error('Error marking messages as read:', error);
      }
    }
    
    // Load messages
    function loadMessages(chatRoomId) {
      // Clean up previous listener
      if (messagesListeners[chatRoomId]) {
        messagesListeners[chatRoomId]();
      }
      
      const messagesRef = ref(db, `messages/${chatRoomId}`);
      
      messagesListeners[chatRoomId] = onValue(messagesRef, (snapshot) => {
        messagesContainer.innerHTML = '';
        
        if (!snapshot.exists()) {
          messagesContainer.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
              <h3>No messages yet</h3>
              <p>Start the conversation by sending a message</p>
            </div>
          `;
          return;
        }
        
        const messages = snapshot.val();
        const messageIds = Object.keys(messages).sort((a, b) => 
          messages[a].timestamp - messages[b].timestamp
        );
        
        let lastDate = null;
        
        messageIds.forEach(msgId => {
          const msg = messages[msgId];
          const msgDate = new Date(msg.timestamp);
          const dateStr = formatMessageDate(msgDate);
          
          // Add date divider if date changed
          if (dateStr !== lastDate) {
            const divider = document.createElement('div');
            divider.className = 'date-divider';
            divider.innerHTML = `<span>${dateStr}</span>`;
            messagesContainer.appendChild(divider);
            lastDate = dateStr;
          }
          
          // Create message element
          const messageEl = document.createElement('div');
          messageEl.className = `message ${msg.senderId === currentUser.uid ? 'sent' : 'received'}`;
          
          const sender = allUsers[msg.senderId];
          const avatarHtml = sender?.avatar 
            ? `<img src="${sender.avatar}" alt="${sender.nickname}">`
            : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
          
          const time = msgDate.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
          });
          
          // Read receipts for sent messages
          let statusHtml = '';
          if (msg.senderId === currentUser.uid) {
            const status = msg.status || 'sent';
            if (status === 'sent') {
              statusHtml = `
                <div class="message-status sent">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
              `;
            } else if (status === 'delivered') {
              statusHtml = `
                <div class="message-status delivered">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
              `;
            } else if (status === 'read') {
              statusHtml = `
                <div class="message-status read">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
              `;
            }
          }
          
          messageEl.innerHTML = `
            <div class="message-avatar">
              ${avatarHtml}
            </div>
            <div class="message-content">
              <div class="message-bubble">${msg.text}</div>
              <div class="message-footer">
                <span class="message-time">${time}</span>
                ${statusHtml}
              </div>
            </div>
          `;
          
          messagesContainer.appendChild(messageEl);
        });
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Mark as read if chat is open
        if (activeChat?.chatRoomId === chatRoomId) {
          markMessagesAsRead(chatRoomId);
        }
      });
    }
    
    // Send message
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !activeChat) return;
      
      try {
        const messageId = push(ref(db, `messages/${activeChat.chatRoomId}`)).key;
        const timestamp = Date.now();
        
        // Add message
        await set(ref(db, `messages/${activeChat.chatRoomId}/${messageId}`), {
          text,
          senderId: currentUser.uid,
          timestamp,
          status: 'sent'
        });
        
        // Update chat room data
        await update(ref(db, `chatRooms/${activeChat.chatRoomId}`), {
          lastMessage: {
            text,
            senderId: currentUser.uid,
            timestamp
          },
          [`unreadCount/${activeChat.friendId}`]: (chatRoomsData[activeChat.chatRoomId]?.unreadCount?.[activeChat.friendId] || 0) + 1
        });
        
        // Update message status to delivered after a short delay
        setTimeout(async () => {
          await update(ref(db, `messages/${activeChat.chatRoomId}/${messageId}`), {
            status: 'delivered',
            deliveredAt: Date.now()
          });
        }, 500);
        
        // Clear input
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Clear typing status
        setTypingStatus(false);
        
      } catch (error) {
        console.error('Error sending message:', error);
        showToast('Failed to send message', 'error');
      }
    }
  </script>
</body>
</html>

