<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flip the Coin - Game Arena</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated background elements */
        .bg-gradient {
            position: fixed;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.15;
            animation: float 20s ease-in-out infinite;
            z-index: 0;
        }

        .bg-gradient-1 {
            background: linear-gradient(135deg, #3a3a3a, #1a1a1a);
            top: -200px;
            left: -200px;
            animation-delay: 0s;
        }

        .bg-gradient-2 {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            bottom: -200px;
            right: -200px;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(100px, -100px) scale(1.1); }
            66% { transform: translate(-50px, 100px) scale(0.9); }
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .arena-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border: 2px solid #3a3a3a;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo svg {
            width: 40px;
            height: 40px;
            color: #888;
        }

        .arena-header h1 {
            font-size: 2.5em;
            font-weight: 800;
            color: #ffffff;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }

        .arena-header p {
            color: #888;
            font-size: 0.95em;
            font-weight: 500;
        }

        .game-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
            }
        }

        /* Betting Section */
        .betting-section {
            background: linear-gradient(135deg, #1a1a1a, #141414);
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .betting-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f);
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 20px;
            text-align: center;
        }

        .bet-input-group {
            margin-bottom: 20px;
        }

        .bet-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #e0e0e0;
            font-weight: 500;
        }

        .bet-input {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #ffffff;
            font-size: 16px;
        }

        .multiplier-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .multiplier-btn {
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #e0e0e0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .multiplier-btn:hover, .multiplier-btn.active {
            background: #3D4BE3;
            color: #ffffff;
        }

        .bet-summary {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .bet-summary p {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .potential-win {
            font-size: 1.5em;
            font-weight: 800;
            color: #43e97b;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
            color: #000;
            box-shadow: 0 4px 16px rgba(255, 255, 255, 0.1);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #ffffff, #f5f5f5);
            box-shadow: 0 6px 24px rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Game Section */
        .game-section {
            background: linear-gradient(135deg, #1a1a1a, #141414);
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
        }

        .game-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            width: 100%;
        }

        .game-info p {
            font-size: 1.1em;
            font-weight: 600;
        }

        /* Choice Section */
        .choice-section {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }

        .choice-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 20px;
        }

        .choice-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .choice-option {
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid transparent;
            flex: 1;
            min-width: 120px;
            max-width: 150px;
        }

        .choice-option:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-5px);
        }

        .choice-option.selected {
            background: rgba(61, 75, 227, 0.2);
            border-color: #3D4BE3;
        }

        .choice-icon {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #2a2a2a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            margin: 0 auto 10px;
            transition: all 0.3s;
        }

        .choice-option:hover .choice-icon {
            border-color: #3D4BE3;
            transform: scale(1.1);
        }

        .choice-option.selected .choice-icon {
            border-color: #3D4BE3;
            background: rgba(61, 75, 227, 0.1);
        }

        .choice-name {
            font-size: 1em;
            font-weight: 600;
            color: #ffffff;
        }

        /* Coin Flip Section */
        .coin-section {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }

        .coin-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            perspective: 1000px;
        }

        .coin {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 2s ease-out;
        }

        .coin.flipping {
            animation: flip 2s ease-out;
        }

        @keyframes flip {
            0% { transform: rotateY(0); }
            50% { transform: rotateY(1800deg); }
            100% { transform: rotateY(3600deg); }
        }

        .coin-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            font-weight: 800;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .heads {
            background: linear-gradient(135deg, #f9d423, #ff4e50);
            color: #000;
            z-index: 2;
        }

        .tails {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            transform: rotateY(180deg);
        }

        .coin-result {
            font-size: 1.3em;
            font-weight: 700;
            margin-top: 10px;
        }

        .result-display {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 20px;
            width: 100%;
        }

        .result-text {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .result-details {
            color: #888;
            font-size: 1em;
        }

        .game-status {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 20px;
        }

        .game-controls {
            display: flex;
            gap: 15px;
            width: 100%;
        }

        .game-controls .btn {
            flex: 1;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #2a2a2a;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #4a4a4a;
            transform: translateY(-2px);
        }

        /* Token Balance */
        .token-balance {
            background: linear-gradient(135deg, #1a1a1a, #141414);
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .token-balance h3 {
            font-size: 1.2em;
            font-weight: 700;
            color: #ffffff;
        }

        .token-amount {
            font-size: 1.8em;
            font-weight: 800;
            color: #43e97b;
        }

        /* Alert Styles */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: #ffffff;
            font-weight: 600;
            z-index: 1100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateX(150%);
            transition: transform 0.4s ease;
        }

        .alert.show {
            transform: translateX(0);
        }

        .alert-success {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
        }

        .alert-error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .arena-header h1 {
                font-size: 2em;
            }
            
            .multiplier-options {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .choice-options {
                flex-direction: row;
                gap: 10px;
            }
            
            .choice-option {
                min-width: 100px;
                padding: 10px;
            }
            
            .choice-icon {
                width: 60px;
                height: 60px;
                font-size: 2em;
            }
            
            .coin-container {
                width: 120px;
                height: 120px;
            }
        }

        @media (max-width: 480px) {
            .arena-header h1 {
                font-size: 1.8em;
            }

            .logo {
                width: 70px;
                height: 70px;
            }

            .logo svg {
                width: 35px;
                height: 35px;
            }
            
            .choice-option {
                min-width: 80px;
                padding: 8px;
            }
            
            .choice-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }
            
            .coin-container {
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body>

    <div class="bg-gradient bg-gradient-1"></div>
    <div class="bg-gradient bg-gradient-2"></div>

    <div class="container">
        <div class="arena-header">
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            <h1>Flip the Coin</h1>
            <p>Place your bet and test your luck! ðŸŽ²</p>
        </div>

        <div class="token-balance">
            <h3>Your Tokens:</h3>
    <div class="token-amount" id="token-balance">--</div>
        </div>

        <div class="game-container">
            <!-- Betting Section -->
            <div class="betting-section">
                <h2 class="section-title">Place Your Bet</h2>
                
                <div class="bet-input-group">
                    <label for="bet-amount">Bet Amount (Minimum: 50 tokens)</label>
                    <input type="number" id="bet-amount" class="bet-input" min="50" value="50">
                </div>
                
                <div class="bet-input-group">
                    <label>Select Multiplier</label>
                    <div class="multiplier-options">
                        <div class="multiplier-btn active" data-multiplier="2">2x</div>
                        <div class="multiplier-btn" data-multiplier="3">3x</div>
                        <div class="multiplier-btn" data-multiplier="4">4x</div>
                    </div>
                </div>
                
                <div class="bet-summary">
                    <p>Potential Win</p>
                    <div class="potential-win" id="potential-win">100 tokens</div>
                </div>
                
                <button id="place-bet-btn" class="btn btn-primary">Place Bet</button>
            </div>

            <!-- Game Section -->
            <div class="game-section">
                <div class="game-info">
                    <p>Bet: <span id="current-bet">0</span> tokens | Multiplier: <span id="current-multiplier">1x</span></p>
                </div>
                
                <!-- Choice Section -->
                <div class="choice-section">
                    <div class="choice-title">Choose Heads or Tails</div>
                    <div class="choice-options">
                        <div class="choice-option" data-choice="heads">
                            <div class="choice-icon">H</div>
                            <div class="choice-name">Heads</div>
                        </div>
                        <div class="choice-option" data-choice="tails">
                            <div class="choice-icon">T</div>
                            <div class="choice-name">Tails</div>
                        </div>
                    </div>
                    <button id="confirm-choice-btn" class="btn btn-primary" disabled>Flip Coin</button>
                </div>
                
                <!-- Coin Flip Section -->
                <div class="coin-section">
                    <div class="coin-container">
                        <div class="coin" id="coin">
                            <div class="coin-face heads">H</div>
                            <div class="coin-face tails">T</div>
                        </div>
                    </div>
                    <div class="coin-result" id="coin-result">Ready to flip!</div>
                </div>
                
                <div class="result-display">
                    <div class="result-text" id="result-text">Make your prediction!</div>
                    <div class="result-details" id="result-details">Select heads or tails and flip the coin</div>
                </div>
                
                <div class="game-status">
                    <p id="game-status-text">Place a bet to start playing</p>
                </div>
                
                <div class="game-controls">
                    <button id="play-again-btn" class="btn btn-secondary">Play Again</button>
                    <button id="new-bet-btn" class="btn btn-primary">New Bet</button>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="win-alert" class="alert alert-success">Congratulations! You won <span id="win-amount">0</span> tokens!</div>
        <div id="lose-alert" class="alert alert-error">Sorry! You lost your bet.</div>
    </div>
    
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { ref, getDatabase, onValue, runTransaction, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
import { onAuthStateChanged, getAuth } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBsOwXNtfaWwEh3qaM0suXafOg6CYLzDC8",
    authDomain: "uamtv-c031c.firebaseapp.com",
    databaseURL: "https://uamtv-c031c-default-rtdb.firebaseio.com",
    projectId: "uamtv-c031c",
    storageBucket: "uamtv-c031c.firebasestorage.app",
    messagingSenderId: "9790917697",
    appId: "1:9790917697:web:275c8347b7688e0ac38ac0",
    measurementId: "G-RSXW1XBVQZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase();

console.log('ðŸ”¥ Firebase initialized');
console.log('ðŸ’¾ Database ready');

// Firebase variables
let userRef;
let currentUser = null;

// Game state
const gameState = {
    betAmount: 0,
    multiplier: 2,
    playerTokenBalance: 0,
    gameActive: false,
    betPlaced: false,
    playerChoice: null,
    coinResult: null
};

// DOM Elements
let tokenBalanceElement = document.getElementById('token-balance');
const betAmountInput = document.getElementById('bet-amount');
const multiplierButtons = document.querySelectorAll('.multiplier-btn');
const potentialWinElement = document.getElementById('potential-win');
const placeBetBtn = document.getElementById('place-bet-btn');
const currentBetElement = document.getElementById('current-bet');
const currentMultiplierElement = document.getElementById('current-multiplier');
const choiceOptions = document.querySelectorAll('.choice-option');
const confirmChoiceBtn = document.getElementById('confirm-choice-btn');
const coinElement = document.getElementById('coin');
const coinResultElement = document.getElementById('coin-result');
const resultText = document.getElementById('result-text');
const resultDetails = document.getElementById('result-details');
const gameStatusText = document.getElementById('game-status-text');
const playAgainBtn = document.getElementById('play-again-btn');
const newBetBtn = document.getElementById('new-bet-btn');
const winAlert = document.getElementById('win-alert');
const loseAlert = document.getElementById('lose-alert');
const winAmountElement = document.getElementById('win-amount');

// Create audio objects
const audioAssets = {
    win: new Audio('../Assets/musics/win.mp3'),
    loose: new Audio('../Assets/musics/loose.mp3')
};

// Preload and configure
audioAssets.win.preload = 'auto';
audioAssets.loose.preload = 'auto';
audioAssets.win.volume = 0.7;
audioAssets.loose.volume = 0.7;

// Audio unlocked flag
let audioUnlocked = false;

// Unlock audio on first user interaction
function unlockAudio() {
    if (audioUnlocked) return;
    
    // Play and immediately pause to unlock
    audioAssets.win.play().then(() => {
        audioAssets.win.pause();
        audioAssets.win.currentTime = 0;
    }).catch(() => {});
    
    audioAssets.loose.play().then(() => {
        audioAssets.loose.pause();
        audioAssets.loose.currentTime = 0;
    }).catch(() => {});
    
    audioUnlocked = true;
    console.log('âœ… Audio unlocked');
}

// Add unlock listener to the place bet button
placeBetBtn.addEventListener('click', unlockAudio);

// Functions to play audio with error handling
function playWin() {
    audioAssets.win.currentTime = 0;
    audioAssets.win.play().catch(err => {
        console.log('Win audio play failed:', err.message);
    });
}

function playLoose() {
    audioAssets.loose.currentTime = 0;
    audioAssets.loose.play().catch(err => {
        console.log('Loose audio play failed:', err.message);
    });
}
// Firebase Auth State
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        const userId = user.uid;
        userRef = ref(db, "users/" + userId + "/tokens");

        // Listen to user balance changes
        onValue(userRef, (snapshot) => {
            if (snapshot.exists()) {
                const tokens = snapshot.val();
                gameState.playerTokenBalance = tokens;
                tokenBalanceElement.textContent = tokens;
                
                console.log("âœ… Balance synced from Firebase:", tokens);
                
                // Check if tokens are zero and disable betting
                if (tokens === 0) {
                    placeBetBtn.disabled = true;
                    if (!gameState.betPlaced) {
                        gameStatusText.textContent = 'No tokens left! Game over.';
                    }
                } else if (!gameState.betPlaced) {
                    placeBetBtn.disabled = false;
                    gameStatusText.textContent = 'Place a bet to start playing';
                }
            }
        }, (error) => {
            console.error("Error fetching user data:", error);
        });
    } else {
        console.log("No user logged in");
    }
});

// Event Listeners
betAmountInput.addEventListener('input', updatePotentialWin);

multiplierButtons.forEach(button => {
    button.addEventListener('click', function() {
        multiplierButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        gameState.multiplier = parseInt(this.getAttribute('data-multiplier'));
        updatePotentialWin();
    });
});

placeBetBtn.addEventListener('click', placeBet);

choiceOptions.forEach(option => {
    option.addEventListener('click', function() {
        if (!gameState.gameActive || !gameState.betPlaced) return;
        
        choiceOptions.forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        gameState.playerChoice = this.getAttribute('data-choice');
        
        confirmChoiceBtn.disabled = false;
        coinResultElement.textContent = `You chose: ${gameState.playerChoice.toUpperCase()}`;
    });
});

confirmChoiceBtn.addEventListener('click', flipCoin);
playAgainBtn.addEventListener('click', playAgain);
newBetBtn.addEventListener('click', newBet);

// Functions
function updatePotentialWin() {
    const betAmount = parseInt(betAmountInput.value) || 0;
    const potentialWin = betAmount * gameState.multiplier;
    potentialWinElement.textContent = `${potentialWin} tokens`;
}

async function placeBet() {
    const betAmount = parseInt(betAmountInput.value);
    
    if (!currentUser) {
        alert('Please log in to play');
        return;
    }
    
    if (betAmount < 50) {
        alert('Minimum bet is 50 tokens');
        return;
    }
    
    if (gameState.playerTokenBalance === 0) {
        alert('You have no tokens left to bet!');
        return;
    }
    
    if (betAmount > gameState.playerTokenBalance) {
        alert('Insufficient tokens');
        return;
    }
    
    console.log('ðŸ’° PLACING BET');
    console.log('   Bet amount:', betAmount);
    console.log('   Multiplier:', gameState.multiplier + 'x');
    console.log('   Balance BEFORE bet:', gameState.playerTokenBalance);
    
    try {
        // Use transaction to atomically deduct tokens
        const result = await runTransaction(userRef, (currentTokens) => {
            if (currentTokens === null) {
                return currentTokens;
            }
            if (currentTokens < betAmount) {
                console.error('Insufficient tokens in transaction');
                return; // Abort transaction
            }
            const newBalance = currentTokens - betAmount;
            console.log('   Deducting', betAmount, 'tokens');
            console.log('   Balance AFTER bet:', newBalance);
            return newBalance;
        });
        
        if (result.committed) {
            console.log("âœ… Bet placed successfully - tokens deducted");
            
            gameState.betAmount = betAmount;
            gameState.betPlaced = true;
            gameState.gameActive = true;
            
            // Update UI
            currentBetElement.textContent = betAmount;
            currentMultiplierElement.textContent = `${gameState.multiplier}x`;
            gameStatusText.textContent = "Select heads or tails!";
            
            // Disable betting section
            betAmountInput.disabled = true;
            placeBetBtn.disabled = true;
            multiplierButtons.forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.style.opacity = '0.6';
            });
            
            // Enable choice options
            choiceOptions.forEach(option => {
                option.style.pointerEvents = 'auto';
            });
        }
    } catch (err) {
        console.error("âŒ Error placing bet:", err);
        alert('Error placing bet. Please try again.');
    }
}

function flipCoin() {
    if (!gameState.playerChoice) return;
    
    gameState.gameActive = false;
    
    // Disable choice options and confirm button
    choiceOptions.forEach(option => {
        option.style.pointerEvents = 'none';
    });
    confirmChoiceBtn.disabled = true;
    
    // Reset coin animation
    coinElement.classList.remove('flipping');
    void coinElement.offsetWidth; // Trigger reflow
    
    // Show flipping animation
    coinResultElement.textContent = "Flipping...";
    resultText.textContent = "The coin is flipping!";
    resultDetails.textContent = "";
    gameStatusText.textContent = 'Coin is flipping...';
    
    // Start coin flip animation
    coinElement.classList.add('flipping');
    
    // Determine coin result after animation
    setTimeout(() => {
        const randomResult = Math.random() < 0.5 ? 'heads' : 'tails';
        gameState.coinResult = randomResult;
        
        // Update coin display to show result
        if (randomResult === 'heads') {
            coinElement.style.transform = 'rotateY(0deg)';
        } else {
            coinElement.style.transform = 'rotateY(180deg)';
        }
        
        coinResultElement.textContent = `Result: ${randomResult.toUpperCase()}`;
        
        // Determine win/loss
        const result = gameState.playerChoice === randomResult ? 'win' : 'lose';
        
        console.log('ðŸŽ² COIN FLIP RESULT');
        console.log('   Coin landed on:', randomResult);
        console.log('   Player chose:', gameState.playerChoice);
        console.log('   Outcome:', result.toUpperCase());
        
        // Display result
        displayResult(result, randomResult);
        
        // Update token balance based on result
        updateTokenBalance(result);
    }, 2000);
}
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { ref, getDatabase, onValue, runTransaction, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
import { onAuthStateChanged, getAuth } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBsOwXNtfaWwEh3qaM0suXafOg6CYLzDC8",
    authDomain: "uamtv-c031c.firebaseapp.com",
    databaseURL: "https://uamtv-c031c-default-rtdb.firebaseio.com",
    projectId: "uamtv-c031c",
    storageBucket: "uamtv-c031c.firebasestorage.app",
    messagingSenderId: "9790917697",
    appId: "1:9790917697:web:275c8347b7688e0ac38ac0",
    measurementId: "G-RSXW1XBVQZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase();

console.log('ðŸ”¥ Firebase initialized');
console.log('ðŸ’¾ Database ready');

// Firebase variables
let userRef;
let currentUser = null;

// Game state
const gameState = {
    betAmount: 0,
    multiplier: 2,
    playerTokenBalance: 0,
    gameActive: false,
    betPlaced: false,
    playerChoice: null,
    coinResult: null
};

// DOM Elements
let tokenBalanceElement = document.getElementById('token-balance');
const betAmountInput = document.getElementById('bet-amount');
const multiplierButtons = document.querySelectorAll('.multiplier-btn');
const potentialWinElement = document.getElementById('potential-win');
const placeBetBtn = document.getElementById('place-bet-btn');
const currentBetElement = document.getElementById('current-bet');
const currentMultiplierElement = document.getElementById('current-multiplier');
const choiceOptions = document.querySelectorAll('.choice-option');
const confirmChoiceBtn = document.getElementById('confirm-choice-btn');
const coinElement = document.getElementById('coin');
const coinResultElement = document.getElementById('coin-result');
const resultText = document.getElementById('result-text');
const resultDetails = document.getElementById('result-details');
const gameStatusText = document.getElementById('game-status-text');
const playAgainBtn = document.getElementById('play-again-btn');
const newBetBtn = document.getElementById('new-bet-btn');
const winAlert = document.getElementById('win-alert');
const loseAlert = document.getElementById('lose-alert');
const winAmountElement = document.getElementById('win-amount');

// Create audio objects
const audioAssets = {
    win: new Audio('../Assets/musics/win.mp3'),
    loose: new Audio('../Assets/musics/loose.mp3')
};

// Preload and configure
audioAssets.win.preload = 'auto';
audioAssets.loose.preload = 'auto';
audioAssets.win.volume = 0.7;
audioAssets.loose.volume = 0.7;

// Audio unlocked flag
let audioUnlocked = false;

// Unlock audio on first user interaction
function unlockAudio() {
    if (audioUnlocked) return;
    
    // Play and immediately pause to unlock
    audioAssets.win.play().then(() => {
        audioAssets.win.pause();
        audioAssets.win.currentTime = 0;
    }).catch(() => {});
    
    audioAssets.loose.play().then(() => {
        audioAssets.loose.pause();
        audioAssets.loose.currentTime = 0;
    }).catch(() => {});
    
    audioUnlocked = true;
    console.log('âœ… Audio unlocked');
}

// Add unlock listener to the place bet button
placeBetBtn.addEventListener('click', unlockAudio);

// Functions to play audio with error handling
function playWin() {
    audioAssets.win.currentTime = 0;
    audioAssets.win.play().catch(err => {
        console.log('Win audio play failed:', err.message);
    });
}

function playLoose() {
    audioAssets.loose.currentTime = 0;
    audioAssets.loose.play().catch(err => {
        console.log('Loose audio play failed:', err.message);
    });
}

// Firebase Auth State
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        const userId = user.uid;
        userRef = ref(db, "users/" + userId + "/tokens");

        // Listen to user balance changes
        onValue(userRef, (snapshot) => {
            if (snapshot.exists()) {
                const tokens = snapshot.val();
                gameState.playerTokenBalance = tokens;
                tokenBalanceElement.textContent = tokens;
                
                console.log("âœ… Balance synced from Firebase:", tokens);
                
                // Check if tokens are zero and disable betting
                if (tokens === 0) {
                    placeBetBtn.disabled = true;
                    if (!gameState.betPlaced) {
                        gameStatusText.textContent = 'No tokens left! Game over.';
                    }
                } else if (!gameState.betPlaced) {
                    placeBetBtn.disabled = false;
                    gameStatusText.textContent = 'Place a bet to start playing';
                }
            }
        }, (error) => {
            console.error("Error fetching user data:", error);
        });
    } else {
        console.log("No user logged in");
    }
});

// Event Listeners
betAmountInput.addEventListener('input', updatePotentialWin);

multiplierButtons.forEach(button => {
    button.addEventListener('click', function() {
        multiplierButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        gameState.multiplier = parseInt(this.getAttribute('data-multiplier'));
        updatePotentialWin();
    });
});

placeBetBtn.addEventListener('click', placeBet);

choiceOptions.forEach(option => {
    option.addEventListener('click', function() {
        if (!gameState.gameActive || !gameState.betPlaced) return;
        
        choiceOptions.forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        gameState.playerChoice = this.getAttribute('data-choice');
        
        confirmChoiceBtn.disabled = false;
        coinResultElement.textContent = `You chose: ${gameState.playerChoice.toUpperCase()}`;
    });
});

confirmChoiceBtn.addEventListener('click', flipCoin);
playAgainBtn.addEventListener('click', playAgain);
newBetBtn.addEventListener('click', newBet);

// Functions
function updatePotentialWin() {
    const betAmount = parseInt(betAmountInput.value) || 0;
    const potentialWin = betAmount * gameState.multiplier;
    potentialWinElement.textContent = `${potentialWin} tokens`;
}

async function placeBet() {
    const betAmount = parseInt(betAmountInput.value);
    
    if (!currentUser) {
        alert('Please log in to play');
        return;
    }
    
    if (betAmount < 50) {
        alert('Minimum bet is 50 tokens');
        return;
    }
    
    if (gameState.playerTokenBalance === 0) {
        alert('You have no tokens left to bet!');
        return;
    }
    
    if (betAmount > gameState.playerTokenBalance) {
        alert('Insufficient tokens');
        return;
    }
    
    console.log('ðŸ’° PLACING BET');
    console.log('   Bet amount:', betAmount);
    console.log('   Multiplier:', gameState.multiplier + 'x');
    console.log('   Balance BEFORE bet:', gameState.playerTokenBalance);
    
    try {
        // Use transaction to atomically deduct tokens
        const result = await runTransaction(userRef, (currentTokens) => {
            if (currentTokens === null) {
                return currentTokens;
            }
            if (currentTokens < betAmount) {
                console.error('Insufficient tokens in transaction');
                return; // Abort transaction
            }
            const newBalance = currentTokens - betAmount;
            console.log('   Deducting', betAmount, 'tokens');
            console.log('   Balance AFTER bet:', newBalance);
            return newBalance;
        });
        
        if (result.committed) {
            console.log("âœ… Bet placed successfully - tokens deducted");
            
            gameState.betAmount = betAmount;
            gameState.betPlaced = true;
            gameState.gameActive = true;
            
            // Update UI
            currentBetElement.textContent = betAmount;
            currentMultiplierElement.textContent = `${gameState.multiplier}x`;
            gameStatusText.textContent = "Select heads or tails!";
            
            // Disable betting section
            betAmountInput.disabled = true;
            placeBetBtn.disabled = true;
            multiplierButtons.forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.style.opacity = '0.6';
            });
            
            // Enable choice options
            choiceOptions.forEach(option => {
                option.style.pointerEvents = 'auto';
            });
        }
    } catch (err) {
        console.error("âŒ Error placing bet:", err);
        alert('Error placing bet. Please try again.');
    }
}

function flipCoin() {
    if (!gameState.playerChoice) return;
    
    gameState.gameActive = false;
    
    // Disable choice options and confirm button
    choiceOptions.forEach(option => {
        option.style.pointerEvents = 'none';
    });
    confirmChoiceBtn.disabled = true;
    
    // Reset coin animation
    coinElement.classList.remove('flipping');
    void coinElement.offsetWidth; // Trigger reflow
    
    // Show flipping animation
    coinResultElement.textContent = "Flipping...";
    resultText.textContent = "The coin is flipping!";
    resultDetails.textContent = "";
    gameStatusText.textContent = 'Coin is flipping...';
    
    // Start coin flip animation
    coinElement.classList.add('flipping');
    
    // Determine coin result after animation
    setTimeout(() => {
        // MODIFIED: Give player 20% chance to win (0.2 = 20%)
        // Change this value to adjust win rate:
        // 0.1 = 10% player wins
        // 0.2 = 20% player wins
        // 0.3 = 30% player wins
        // 0.4 = 40% player wins
        const playerWinChance = 0.2; // 20% chance to win
        const shouldPlayerWin = Math.random() < playerWinChance;
        
        let randomResult;
        if (shouldPlayerWin) {
            // Let them win - coin matches their choice
            randomResult = gameState.playerChoice;
        } else {
            // House wins - coin is opposite of their choice
            randomResult = gameState.playerChoice === 'heads' ? 'tails' : 'heads';
        }
        
        gameState.coinResult = randomResult;
        
        // Update coin display to show result
        if (randomResult === 'heads') {
            coinElement.style.transform = 'rotateY(0deg)';
        } else {
            coinElement.style.transform = 'rotateY(180deg)';
        }
        
        coinResultElement.textContent = `Result: ${randomResult.toUpperCase()}`;
        
        // Determine win/loss
        const result = gameState.playerChoice === randomResult ? 'win' : 'lose';
        
        console.log('ðŸŽ² COIN FLIP RESULT');
        console.log('   Coin landed on:', randomResult);
        console.log('   Player chose:', gameState.playerChoice);
        console.log('   Outcome:', result.toUpperCase());
        
        // Display result
        displayResult(result, randomResult);
        
        // Update token balance based on result
        updateTokenBalance(result);
    }, 2000);
}



function displayResult(result, coinResult) {
    if (result === 'win') {
        const winAmount = gameState.betAmount * gameState.multiplier;
        resultText.textContent = 'You Win!';
        resultDetails.textContent = `Coin landed on ${coinResult.toUpperCase()} - you won ${winAmount} tokens!`;
        resultText.style.color = '#43e97b';
        gameStatusText.textContent = 'You won! Place a new bet to play again.';
    } else {
        resultText.textContent = 'You Lose!';
        resultDetails.textContent = `Coin landed on ${coinResult.toUpperCase()} - you lost ${gameState.betAmount} tokens!`;
        resultText.style.color = '#ff6b6b';
        gameStatusText.textContent = 'You lost! Place a new bet to play again.';
    }
}

async function updateTokenBalance(result) {
    try {
        if (result === 'win') {
            // Calculate total payout: original bet + winnings
            const winnings = gameState.betAmount * gameState.multiplier;
            const totalPayout = gameState.betAmount + winnings; // Return bet + winnings
            playWin();
            console.log('ðŸŽ‰ PLAYER WON!');
            console.log('   Bet amount:', gameState.betAmount);
            console.log('   Multiplier:', gameState.multiplier + 'x');
            console.log('   Winnings:', winnings);
            console.log('   Total payout (bet + winnings):', totalPayout);
            console.log('   Balance BEFORE payout:', gameState.playerTokenBalance);
            
            // Use transaction to atomically add total payout
            const result = await runTransaction(userRef, (currentTokens) => {
                if (currentTokens === null) {
                    return currentTokens;
                }
                const newBalance = currentTokens + totalPayout;
                console.log('   Adding', totalPayout, 'tokens');
                console.log('   Balance AFTER payout:', newBalance);
                return newBalance;
            });
            
            if (result.committed) {
                winAmountElement.textContent = winnings;
                showAlert(winAlert, `Congratulations! You won ${winnings} tokens!`);
                console.log("âœ… Win processed successfully");
            }
        } else {
            // User loses - tokens ALREADY deducted when bet was placed
            // DO NOT DEDUCT AGAIN - just show the alert
            playLoose();
            console.log('ðŸ˜¢ PLAYER LOST!');
            console.log('   Lost bet amount:', gameState.betAmount);
            console.log('   Current balance:', gameState.playerTokenBalance);
            console.log('   âš ï¸  NO DEDUCTION - tokens were already taken when bet was placed');
            
            showAlert(loseAlert, `Sorry! You lost ${gameState.betAmount} tokens.`);
        }
        
        // Check if user has run out of tokens after a short delay to let Firebase sync
        setTimeout(() => {
            if (gameState.playerTokenBalance === 0) {
                gameStatusText.textContent = 'No tokens left! Game over.';
                placeBetBtn.disabled = true;
            }
        }, 500);
    } catch (err) {
        console.error("âŒ Error updating tokens:", err);
    }
}

function showAlert(alertElement, message) {
    alertElement.textContent = message;
    alertElement.classList.add('show');
    
    setTimeout(() => {
        alertElement.classList.remove('show');
    }, 3000);
}

async function playAgain() {
    if (!gameState.betPlaced) return;
    
    // Check if user has enough tokens to play again with same bet
    if (gameState.playerTokenBalance < gameState.betAmount) {
        alert('Insufficient tokens to play again with the same bet. Please place a new bet.');
        newBet();
        return;
    }
    
    const betAmount = gameState.betAmount;
    console.log('ðŸ” PLAYING AGAIN');
    console.log('   Bet amount:', betAmount);
    console.log('   Multiplier:', gameState.multiplier + 'x');
    console.log('   Balance BEFORE bet:', gameState.playerTokenBalance);
    
    try {
        // Use transaction to atomically deduct tokens for new round
        const result = await runTransaction(userRef, (currentTokens) => {
            if (currentTokens === null) {
                return currentTokens;
            }
            if (currentTokens < betAmount) {
                console.error('Insufficient tokens in transaction');
                return; // Abort transaction
            }
            const newBalance = currentTokens - betAmount;
            console.log('   Deducting', betAmount, 'tokens');
            console.log('   Balance AFTER bet:', newBalance);
            return newBalance;
        });
        
        if (result.committed) {
            console.log("âœ… Play again bet placed successfully");
            
            gameState.gameActive = true;
            gameState.playerChoice = null;
            gameState.coinResult = null;
            
            // Reset UI
            coinElement.classList.remove('flipping');
            coinElement.style.transform = 'rotateY(0deg)';
            coinResultElement.textContent = 'Ready to flip!';
            resultText.textContent = 'Make your prediction!';
            resultDetails.textContent = 'Select heads or tails and flip the coin';
            resultText.style.color = '#ffffff';
            gameStatusText.textContent = 'Select heads or tails!';
            
            // Re-enable choice options
            choiceOptions.forEach(option => {
                option.style.pointerEvents = 'auto';
                option.classList.remove('selected');
            });
            confirmChoiceBtn.disabled = true;
        }
    } catch (err) {
        console.error("âŒ Error playing again:", err);
        alert('Error playing again. Please try again.');
    }
}

function newBet() {
    // Reset game state
    gameState.gameActive = false;
    gameState.betPlaced = false;
    gameState.playerChoice = null;
    gameState.coinResult = null;
    
    console.log('ðŸ†• NEW BET - Resetting game');
    console.log('   Current balance:', gameState.playerTokenBalance);
    
    // Reset UI
    coinElement.classList.remove('flipping');
    coinElement.style.transform = 'rotateY(0deg)';
    coinResultElement.textContent = 'Ready to flip!';
    resultText.textContent = 'Make your prediction!';
    resultDetails.textContent = 'Select heads or tails and flip the coin';
    resultText.style.color = '#ffffff';
    
    currentBetElement.textContent = '0';
    currentMultiplierElement.textContent = '1x';
    
    // Enable betting section only if user has tokens
    betAmountInput.disabled = false;
    
    if (gameState.playerTokenBalance === 0) {
        placeBetBtn.disabled = true;
        gameStatusText.textContent = 'No tokens left! Game over.';
    } else {
        placeBetBtn.disabled = false;
        gameStatusText.textContent = 'Place a bet to start playing';
    }
    
    multiplierButtons.forEach(btn => {
        btn.style.pointerEvents = 'auto';
        btn.style.opacity = '1';
    });
    
    // Disable choice options
    choiceOptions.forEach(option => {
        option.style.pointerEvents = 'none';
        option.classList.remove('selected');
    });
    confirmChoiceBtn.disabled = true;
}

// Initialize
updatePotentialWin();

// Disable choice options initially
choiceOptions.forEach(option => {
    option.style.pointerEvents = 'none';
});
confirmChoiceBtn.disabled = true;
</script>
</body>
</html>
